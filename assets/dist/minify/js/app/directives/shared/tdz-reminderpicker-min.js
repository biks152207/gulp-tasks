(function(){app.directive("tdzReminderpicker",["$timeout","$ionicModal","settingsService","userModel","date","guidGenerator","reminderService","message","$q","dbEnums","roleValidators",function(e,i,n,a,r,t,d,o,l,m,s){return{require:"ngModel",scope:{ngModel:"=",assignees:"=",dueDate:"=",callback:"&",isEmailEnabled:"=",defaultReminderChannels:"="},link:function(c,u,f){function h(){i.fromTemplateUrl("html/directives/shared/tdz-reminderpicker/reminder.html",function(e){c.modal=e,c.modal.show()},{scope:c,animation:"scale-in"}),i.fromTemplateUrl("html/directives/shared/tdz-reminderpicker/assignees.html",function(e){c.userModal=e},{scope:c,animation:"scale-in"}),i.fromTemplateUrl("html/directives/shared/tdz-reminderpicker/notification-channels.html",function(e){c.notificationChannelModal=e},{scope:c,animation:"scale-in"}),i.fromTemplateUrl("html/directives/shared/tdz-reminderpicker/reminder-time.html",function(e){c.reminderTimeModal=e},{scope:c,animation:"scale-in"})}function g(){c.reminder=c.ngModel||E,c.noDueDate=!c.dueDate,c.isDifferentUser=!1,c.valid=!0,c.notificationChannels=angular.copy(c.defaultReminderChannels||d.notificationChannels),c.isEmailEnabled||(c.notificationChannels.email.value=!1,c.notificationChannels.email.notified=!0,c.notificationChannels.push.value=!0,c.notificationChannels.push.notified=!1),c.reminderTime=d.timeDuration,c.reminder.assignee=C,c.reminder.notificationChannels=angular.copy(c.notificationChannels),c.users=angular.copy(c.assignees),c.users.splice(0,1),c.users.length||c.users.push(a.getLoggedInUser())}function v(){c.reminder.dateTime=new Date;var e=new Date(T.reminder.defaultTime);c.reminder.dateTime.setHours(e.getHours()),c.reminder.dateTime.setMinutes(e.getMinutes())}function p(){var e=moment(new Date);if(c.valid=!!c.reminder.time,c.validationError=o.errorMessages.REMINDER_TIME_REQUIRED,c.valid&&1==c.reminder.time.id&&e.diff(c.reminder.time.value)>R)c.valid=!1,c.validationError=o.errorMessages.REMINDER_TIME_VALIDATION_ERROR_FOR_FIXED;else if(c.valid&&0==c.reminder.time.id){var i=d.getScheduledTime(c.reminder,c.dueDate);r.isAfter(i,e)||(c.valid=!1,c.validationError=o.errorMessages.REMINDER_TIME_VALIDATION_ERROR_FOR_RELATIVE)}}var E={},R=-12e4,M=null,T=n.getSettings(),C=a.getLoggedInUser();u.on("click",function(){g(),h(),v()}),c.addChannels=function(){(c.notificationChannels.email.value||c.notificationChannels.push.value)&&(c.reminder.notificationChannels=angular.copy(c.notificationChannels),c.notificationChannelModal.hide())},c.channelClicked=function(e){var i=l(function(i,n){if("Email"==e.title&&0==e.value){var r=a.getLoggedInUser();s.checkUserRole(r,m.USER_ROLES.EMAIL_NOTIFICATIONS,{},!0).then(i,n)}else i()});i.then(function(){e.value=!e.value,e.notified=!e.value})},c.openNotificationChannelModal=function(){c.notificationChannels=angular.copy(c.reminder.notificationChannels),c.notificationChannelModal.show()},c.updateAssignee=function(e){c.reminder.assignee=e,c.isDifferentUser=C._id!=e._id},c.updateReminderDate=function(e){"CUSTOM_DATE"==e?(c.reminder.time.id=1,c.reminder.time.value=angular.copy(c.reminder.dateTime),c.reminder.time.title=r.getDateTime(c.reminder.time.value),M=angular.copy(c.reminder.time),v(),p()):c.reminder.time=angular.copy(M)},c.updateReminderTime=function(e){e?(c.reminder.time=angular.copy(e),c.reminder.time.id=0,M=angular.copy(c.reminder.time),p()):c.reminder.time=angular.copy(M),c.reminderTimeModal.hide()},c.save=function(){p(),c.valid&&(c.reminder.id=t.getId(),c.reminder.updatedBy=a.getLoggedInUser(),c.reminder.date_created=new Date,c.ngModel=c.reminder,e(function(){c.modal.remove(),c.callback({newReminder:!0})}))},c.close=function(){c.modal.remove(),c.callback({newReminder:!1})},c.$watch("reminder.time.id",function(e){0!=e&&1!=e||(c.valid=!0)})}}}])}).call(this);