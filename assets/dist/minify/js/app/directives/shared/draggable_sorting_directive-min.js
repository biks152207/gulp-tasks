(function(){app.directive("sortable",["$ionicGesture","$ionicScrollDelegate","$timeout",function(e,t,o){return{restrict:"A",link:function(o,n,i){function r(e,t,o,n){var i,r,s="",a=o[e];if(e<o.length)if(e>0){var l=o[e-1],c=$(l).position().top+$(l).height()+1,f=$(a).position().top+1;t-c<f-t?(s="insertAfter",r=l,i=n.index(r)):(s="insertBefore",r=a,i=n.index(r))}else s="insertBefore",r=a,i=n.index(a);else s="insertAfter",a=o[e-1],r=a,i=n.index(a);return{closestIndex:i,relativeCard:r,positionToInsert:s}}var s,a,l,c,f,d,u,p,g={draggable:i.draggable?i.draggable:".card",duration:200},h=null,v=null,x=0,m=0,I=!1,b=function(e){return $("<div></div>").css({height:e+"px",marginTop:(c>0?-m:-1)+"px"}).addClass("placeholder")},T=function(e){if(h=angular.element(e.target).closest(g.draggable),h.length||(h=null),h){a=n.find(g.draggable),l=c=a.index(h);var t=h.position(),o=e.gesture.touches[0].clientY;x=o-t.top-n.offset().top,h.css({position:"absolute",zIndex:1e3,left:t.left+"px",top:t.top+"px",width:h.outerWidth()+"px"}).addClass("dragging"),s=a.not(".dragging");var i=o-x-n.offset().top,$=r(l,i,s,a);f=$.closestIndex,d=f,m=parseInt(h.css("marginTop"))+1,u=h.outerHeight()+m,v=b(u),v.insertAfter(h),G(),p=setInterval(j,20)}},C=e.on("hold",T,n),A=function(e){if(h){e.stopPropagation(),z=e.touches?e.touches[0].clientY:e.clientY;var t=z-x-n.offset().top;h.css("top",t+"px");var o,i,l=0;s.each(function(e){var n=$(this).position().top;if(t>n&&(l=e+1,o=n,e>0)){var r=s[e-1];i=$(r).position().top+$(r).height()}});if(!I&&l!==c){c=l;var d=v;v=b(1);var p=r(l,t,s,a);p&&(v[p.positionToInsert](p.relativeCard),f=p.closestIndex),I=!0,setTimeout(function(){v&&(v.css("height",u+"px"),d.css("height",1),setTimeout(function(){d.remove(),I=!1},g.duration))},50)}}},y=e.on("touchmove",A,n),B=e.on("mousemove",A,n),Y=function(e){function t(e){h.css({position:"",zIndex:"",left:"",top:"",width:""}).removeClass("dragging"),e?v.replaceWith(h):v.remove(),v=null,h=null}h&&(clearInterval(p),l===c&&d==f||!i.sorted?t():(o.$fromIndex=l,o.$toIndex=c,o.$closestIndex=f,o.$apply(function(){var e=o[i.sorted],n=e(l,c,f);n&&n.then?n.then(function(){t(!0)},function(){t()}):t()})))},w=e.on("release",Y,n);o.$on("$destroy",function(){e.off(C,"hold",T),e.off(y,"touchmove",A),e.off(B,"mousemove",A),e.off(w,"release",Y),p&&clearInterval(p)});var z,H,P,S,W=80,k=.2,D=t,G=function(){z=-1;var e=n.closest(".scroll"),o=e.parent();H=o.height(),P=o.position().top,S=e.height()-H,$(o).attr("delegate-handle")&&(D=t.$getByHandle($(o).attr("delegate-handle")))},j=function(){var e=0;if(z>=0&&z<P+W?e=z-(P+W):z>=0&&z>H-W&&(e=z-(H-W)),0!==e){var t=D.getScrollPosition().top+k*e;t<0?t=0:t>S&&(t=S),D.scrollTo(0,t,!1)}}}}}])}).call(this);