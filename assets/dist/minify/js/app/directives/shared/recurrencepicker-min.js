(function(){app.directive("tdzRecurrencepicker",["$timeout","$ionicModal","settingsService","date","dueService",function(e,r,c,n,a){return{require:"ngModel",scope:{ngModel:"=",callback:"&"},link:function(t,i,o){function u(){t.recurrencePicker={isRecurring:!0,repeat:t.ngModel.repeat||a.REPEAT_KEY.DAILY,every:t.ngModel.every||1,starts_on:t.ngModel.starts_on||new Date,repeatBy:t.ngModel.repeatBy||0,repeatOn:d(),repeatEnd:t.ngModel.repeatEnd||{id:0,end:null,occurrence:null,remainingOccurrence:null}},t.repeats=a.REPEAT_ITEMS,t.repeatByList=a.REPEAT_BY_ITEMS,t.repeatByList[t.recurrencePicker.repeatBy].checked=!0,t.start_on_display=n.getDateTime(t.recurrencePicker.starts_on),t.updateSummary()}function d(){var e=c.getSettings().start_day.value,r=angular.copy(a.REPEAT_ON_ITEMS);t.ngModel.repeatOn&&_.each(r,function(e){var r=_.find(t.ngModel.repeatOn||[],function(r){return r.title==e.title});r&&(e.checked=r.checked)});for(var n=angular.copy(r),i=0;i<e;i++)r.push(n[i]);return r.splice(0,e),r}function l(){r.fromTemplateUrl("html/directives/shared/repeat.html",function(e){t.repeatModal=e},{scope:t,animation:"scale-in"}),r.fromTemplateUrl("html/directives/shared/repeat_every.html",function(e){t.repeatEveryModal=e},{scope:t,animation:"scale-in"}),r.fromTemplateUrl("html/directives/shared/recurrence_picker.html",function(e){t.modal=e,t.modal.show()},{scope:t,animation:"scale-in"})}function p(){t.repeatEveryModal.remove(),t.repeatModal.remove(),t.modal.remove()}i.on("click",function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.disableScroll(!1),u(),l()}),t.save=function(){var r={isRecurring:!0,repeat:t.recurrencePicker.repeat,every:t.recurrencePicker.every,starts_on:t.recurrencePicker.starts_on||new Date,repeatEnd:t.recurrencePicker.repeatEnd};t.recurrencePicker.repeat===a.REPEAT_KEY.WEEKLY&&(r.repeatOn=t.recurrencePicker.repeatOn),t.recurrencePicker.repeat===a.REPEAT_KEY.MONTHLY&&(r.repeatBy=t.recurrencePicker.repeatBy,r.weekNumber=t.recurrencePicker.weekNumber),t.ngModel=angular.copy(r),p(),e(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.disableScroll(!0),t.callback({model:t.ngModel})})},t.close=function(){p(),window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.disableScroll(!0),t.callback()},t.setStartOn=function(e){e&&(t.start_on_display=n.getDateTime(t.recurrencePicker.starts_on),t.updateSummary())},t.setEndDate=function(e){e&&(t.end_display=n.getDateTime(t.recurrencePicker.repeatEnd.end),t.setRepeatEnd())},t.setRepeat=function(e){t.recurrencePicker.repeat=e,t.updateSummary(),t.repeatModal.hide()},t.setRepeatEvery=function(e){t.recurrencePicker.every=e,t.updateSummary(),t.repeatEveryModal.hide()},t.setRepeatBy=function(){if(t.recurrencePicker.repeatBy){var e=new Date;e.setDate(1);for(var r=0;r<7&&e.getDay()!=t.recurrencePicker.starts_on.getDay();r++)e.setDate(e.getDate()+1);t.recurrencePicker.weekNumber=(t.recurrencePicker.starts_on.getDate()-e.getDate())/7}t.updateSummary()},t.setRepeatEnd=function(){switch(t.recurrencePicker.repeatEnd.id){case 0:t.recurrencePicker.repeatEnd={id:0,end:null,occurrence:null,remainingOccurrence:null};break;case 1:t.recurrencePicker.repeatEnd={id:1,end:null,occurrence:t.recurrencePicker.repeatEnd.occurrence,remainingOccurrence:t.recurrencePicker.repeatEnd.occurrence};break;case 2:t.recurrencePicker.repeatEnd={id:2,end:t.recurrencePicker.repeatEnd.end,occurrence:null,remainingOccurrence:null}}console.log(t.recurrencePicker.repeatEnd),t.updateSummary()},t.updateSummary=function(){t.summary=a.getSummary(t.recurrencePicker),t.recurrencePicker.repeatEnd&&t.recurrencePicker.repeatEnd.end&&(t.end_display=n.getDateTime(t.recurrencePicker.repeatEnd.end))}}}}])}).call(this);