(function(){app.controller("taskListController",["$rootScope","$scope","$stateParams","$state","$timeout","sortService","stringService","filterService","sharedData","date","taskService","taskListView","$ionicLoading","labelService","project","dbEnums","settingsService","platformService","userModel","$ionicScrollDelegate","message","uiHelperService","asyncStackService","$q","$ionicLoading","$location","roleValidators",function(e,t,o,s,n,c,a,l,i,r,u,d,f,m,p,g,h,k,T,S,y,v,b,C,f,$,A){function E(){n(function(){var e=$.search().focusMe;e?v.focusTo(e,S.$getByHandle("tasksScrollHandle"),{offsetTop:20}):o.focusedTaskId&&v.focusTo(o.focusedTaskId,S.$getByHandle("tasksScrollHandle"),{offsetTop:20})},200)}function L(t){R=!0,u.removeFromBulkCompleteList(t),e.$emit("bulk-complete:response",R)}function j(){w(),U=e.$on("taskList-update",function(){t.getAll(t.type,t.object)})}function w(){U&&(U(),U=null)}function I(){var o={};if(o=angular.extend(o,K),t.canSearchCompleted||(o.limit=10),console.log(JSON.stringify(t.searchText)),t.startSearching){if(!t.searchText||t.searchText.name==a.EMPTY){console.log("cancelling search completed load");var s=C.defer();return t.completedLists=[],K.skip=0,t.$broadcast("scroll.infiniteScrollComplete"),s.reject(),s.promise}o.filter=t.searchText}return t.startSearching&&delete o.project,console.log(JSON.stringify(o)),t.searchingCompletedTasks=!0,u.getCompletedTasks(o).then(function(e){e=e||[],e.forEach(function(e){e.due=r.getDateOnly(e.recurrence.due_date)||new Date("01-01-2050"),e.recurrence.due_time=r.getTime(e.recurrence.due_date),e.isOverdued=r.isPastDay(e.recurrence.due_date),e.assignee=u.getAssignee(e),e.isComplete="complete"===e.status}),e.length>0?(t.completedLists=t.completedLists.concat(e),K.skip+=e.length,t.noMoreCompletedItemsAvailable=!1):t.noMoreCompletedItemsAvailable=!0,n(function(){t.searchingCompletedTasks=!1,S.resize(),t.$broadcast("scroll.infiniteScrollComplete"),e.length>0&&v.scrollTo(e[0].id,S.$getByHandle("tasksScrollHandle"),{offsetTop:100,animate:!0},function(){})},200)},function(o){t.searchingCompletedTasks=!1,t.$broadcast("scroll.infiniteScrollComplete"),o.msg&&e.$emit("toast-message",o.msg)}).finally(function(){})}function M(e){function o(){if(t.showCompleted)return t.searchingCompletedTasks=!1,t.noMoreCompletedItemsAvailable=!1,K.skip=0,t.completedLists=[],S.resize(),console.info("skip search : ",e),!(!t.isCompletedEnabled||t.startSearching&&!t.canSearchCompleted)&&I()}var s=N.stack(o);s.promise.then(function(){})}function B(){var e=T.getLoggedInUser();A.checkUserRole(e,g.USER_ROLES.SEARCH,{},!1).then(function(){M(!1)},function(){M(!0)})}function O(e){var t=[];return e.forEach(function(e){t.push(e.name)}),t}function P(){D(),W=e.$on("userInfo-sortOrder",function(){t.getAll(t.type,t.object)})}function D(){W&&(W(),W=null)}function H(e,o){t.completeListVisible=!0;var s=T.getLoggedInUser();A.checkUserRole(s,g.USER_ROLES.SEARCH,{},o).then(function(){t.canSearchCompleted=!0,e&&(t.isCompletedEnabled=!0)},function(){e||(t.isCompletedEnabled=!1)})}var R=!1;t.showCompleted=!1,t.noMoreCompletedItemsAvailable=!1,t.completeListVisible=!1,t.canSearchCompleted=!1,t.isCompletedEnabled=!0,t.searchingCompletedTasks=!1;var x,K={skip:0,limit:25},N=b.createStacker();t.clicked=function(e,o){d.clicked(e,t.type,o?o.shiftKey||window.fixes&&window.fixes.shiftKey:k.isMobileDevice())},t.complete=function(t,o,s){o.stopPropagation(),console.log("item status : "+t.name+"   "+t.status);var c=t.status==g.status.complete;s?n(function(){R||e.$emit("bulk-complete:response",!1),R=!1},3e3):t.status=c?g.status.active:g.status.complete,c?u.removeFromBulkCompleteList(t):u.bulkCompleteRequest([t],s).then(function(){d.clearAllSelected()})},t.getAll=function(c,a){if(s.current.state==i.STATE.CLOSED){var l=o.tasks?o.tasks.split(","):[];return u.getTasksByIds(l).then(function(s){return s&&s.length?(t.taskList=s,e.$emit("task:header-taskList",t.type,s.length,t.object),n(function(){e.$emit("update-sticky")},200),void 0):u.getCompletedTasks({tasks:o.tasks}).then(function(o){t.taskList=o,e.$emit("task:header-taskList",t.type,o.length,t.object)},function(t){e.$emit("toast-message",t.msg)}).finally(function(){})})}return u.getTasksByType(c,a).then(function(o){t.taskList=o,e.$emit("task:header-taskList",t.type,o.length,t.object),n(function(){e.$emit("update-sticky")},200)})},t.pull=function(){var o=e.$on("pull-from-server-complete",function(){t.$broadcast("scroll.refreshComplete"),o()});e.$emit("pull-from-server")},t.redirectToEdit=function(t,o){d.setDefaultView(),o&&o.status==g.status.complete?e.closedTask=o:delete e.closedTask,s.go("/task/edit",{id:t})},t.start=function(){switch(x=!!o.type,t.searchingCompletedTasks=!1,s.current.state){case i.STATE.ASSIGNEE:p.getUserFromAllProjects(o.id).then(function(n){n?(t.object=n,t.type=s.current.state,e.title=n.displayName,t.getAll(t.type,t.object).then(E),K.assignee=o.id,H(!1,!1)):i.home()});break;case i.STATE.FILTER:l.findById(o.id).then(function(o){o?(t.object=o,t.type=s.current.state,e.title=o.name,t.getAll(t.type,t.object).then(E)):i.home()});break;case i.STATE.LABEL:m.findById(o.id).then(function(o){o?(t.object=o,t.type=s.current.state,e.title=o.name,t.getAll(t.type,t.object).then(E)):i.home()});break;case i.STATE.PROJECT:p.findById(o.id).then(function(n){n?(t.object=n,e.title=n.name,t.type=s.current.state,t.getAll(t.type,t.object).then(E),K.project=o.id,H(!0,!1)):i.home()});break;case i.STATE.TASK:t.object=null,t.type=o.type,e.$emit("left-menu:selected",t.type),e.title=u.TASK_TYPE_NAME[t.type],t.getAll(t.type,t.object).then(E);break;case i.STATE.CLOSED:t.object=null,t.type="closed",e.$emit("left-menu:selected",t.type),e.title=u.TASK_TYPE_NAME[t.type],f.show(),t.getAll(t.type,t.object).finally(function(){f.hide()})}T.isAuthenticated()&&(t.allFloatButtons=h.getSettings().float_button?parseInt(h.getSettings().float_button.value):null),t.hasRightMenu=!1,t.hasFooter=!1,t.priorities=u.priorities,e.returnState=s.current,e.returnParams=o,d.clearAllSelected(),n(function(){},100)},t.taskAdd=function(){s.current.state==i.STATE.PROJECT&&u.addProjectToTaskObject(t.object),s.go("/task/add")},t.undoTaskComplete=function(e){L(e)},T.isAuthenticated()&&t.start();var U;j();var F,V=e.$on("task-footer-toggle",function(){t.hasFooter=d.isSelected()}),Y=e.$on("search:start",function(e,o){o?(F=!!t.showCompleted,t.startSearching=o,t.getAll(a.EMPTY),B(!0),console.log(o),S.$getByHandle("tasksScrollHandle").scrollTo(0,0)):(n(function(){t.showCompleted=F,F=null,t.startSearching=o,B()},500),t.getAll(t.type,t.object),t.searchText={name:a.EMPTY},console.log(o))}),J=e.$on("search:tasks",function(e,o){t.searchText={name:o},console.log("search text: ",o),console.log("startSearching: ",t.startSearching),B()}),q=e.$on("task:list-sorted",function(e){t.getAll(t.type,t.object)}),z=e.$on("$stateChangeStart",function(){e.$emit("left-menu:selected",null)});t.$on("$destroy",function(){w(),V(),J(),Y(),q(),N.clear(),W(),G(),Q(),z()}),t.clearRecentTask=function(){console.log("unsetting recentTaskId"),e.recentTaskId=void 0,console.log("unset recentTaskId")},t.loadMoreCompleted=function(e){var t=N.stack(I,[],this);t.promise.then(function(){console.log("load more")})},t.$watch("showCompleted",function(e,o){console.log("showCompleted change : "+e),e!==o&&(e===!1?(t.completedLists=[],t.noMoreCompletedItemsAvailable=!1,K.skip=0):e&&M())}),t.showHideCompleted=function(e){t.showCompleted=!t.showCompleted};var G=e.$on("task-complete",function(){M()});t.unCompleteTask=function(t){console.log(t.status),f.show(),u.unCompleteTasks(t).then(function(t){e.$emit("toast-message",y.successMessages.TASK_UNCOMPLETED),e.$emit("pull-from-server"),x&&d.setDefaultView(),i.taskHome(t[0],t[0].id)},function(o){o&&o.msg&&e.$emit("toast-message",o.msg),t.status=g.status.complete}).finally(function(){f.hide()})};var Q=e.$on("task-reopen",function(e,o){o=o||[],o.forEach(function(e){t.completedLists.forEach(function(o,s){if(o.id==e.id)return t.completedLists.splice(s,1),n(function(){console.log("focusing on task "+e.id),v.focusTo(e.id,S.$getByHandle("tasksScrollHandle"),{offsetTop:20,focusMeBackgroundSelector:".item-content"})},300),!1})})});t.completedLists=[],t.onReorder=function(e,o,s){var n=C.defer();console.log(arguments);var a=O(t.taskList);return console.log("--------old list-------"),console.log(a.join(",")),T.get(function(l){var i=c.getSortType(),r=c.getOrder().value,d=angular.copy(t.taskList);w(),u.moveTask(d,e,o,s,l,i.showDateBar,i,r).then(function(e){e=e||{};var o=e.tasks;o?(_.each(o,function(e){u.setTaskProps(e)}),e.requireSort&&(o=u.sortTasks(o,i,r,l)),t.taskList=o,console.log("--------New list-------"),a=O(o),console.log(a.join(",")),n.resolve()):n.reject()},n.reject).finally(function(){j()})}),n.promise},t.completedLists.forEach(function(e){e.due=r.getDateOnly(e.recurrence.due_date)||new Date("01-01-2050"),e.recurrence.due_time=r.getTime(e.recurrence.due_date),e.isOverdued=r.isPastDay(e.recurrence.due_date),e.assignee=u.getAssignee(e)}),t.checkScrolling=function(){console.info("scrolling"),window.cordova&&cordova.plugins&&cordova.plugins.Keyboard&&cordova.plugins.Keyboard.close()};var W;P()}])}).call(this);