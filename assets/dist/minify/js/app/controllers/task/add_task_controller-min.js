(function(){app.controller("addTaskController",["$q","$scope","$rootScope","$ionicModal","$ionicPopup","$timeout","$state","taskService","dueService","stringService","headerService","guidGenerator","dbEnums","reminderService","sharedData","project","user","labelService","date","message","userModel","roleValidators","settingsService","popupService",function(e,t,a,s,r,n,c,i,o,d,u,l,m,f,k,b,g,p,j,O,h,v,S,y){function D(e){var a=!1;return t.taskObject.watchers&&t.taskObject.watchers.forEach(function(t){t.watcher._id===e._id&&(a=t.checked)}),a}function E(){i.setTaskObject(t.taskObject)}function M(){N=!0,i.clearTaskObject()}function T(){s.fromTemplateUrl("html/views/modals/tasks/projects.html",function(e){t.projectModal=e},{scope:t,animation:"scale-in"}),s.fromTemplateUrl("html/views/modals/tasks/assignees.html",function(e){t.userModal=e},{scope:t,animation:"scale-in"}),s.fromTemplateUrl("html/views/modals/tasks/priorities.html",function(e){t.priorityModal=e},{scope:t,animation:"scale-in"}),s.fromTemplateUrl("html/views/modals/tasks/due_date.html",function(e){t.dueDateModal=e},{scope:t,animation:"scale-in"})}function I(){b.getAll().then(function(e){e&&(e.splice(0,0,k.inbox),t.projects=e)})}function w(){var e=t.taskObject.labels||[];t.taskObject.labels=[],p.getAll().then(function(a){a&&a.forEach(function(a){var s=_.find(e,function(e){return a.id==e.label.id});t.taskObject.labels.push({checked:!!s&&s.checked,label:a})})})}function R(){t.priorities=i.priorities,t.taskObject.priority=3}function A(){var e;t.taskObject.reminders.forEach(function(a){a.date_created=new Date(a.date_created),e=f.getScheduledTime(a,t.taskObject.recurrence.due_date),a.invalid=j.isPast(e)||t.taskObject.recurrence.due_date&&j.isAfter(e,t.taskObject.recurrence.due_date),1==a.time.id&&(a.time.title=j.getDateTime(a.time.value))})}function U(e){var a=h.getLoggedInUser();if(e.recurrence&&e.recurrence.due_date&&e.assignee&&e.assignee._id==a._id){var s=i.addAutoReminder(e.recurrence.due_date);if(s){var r=_.find(e.reminders,function(e){return e.auto});r||(e.reminders.push(s),t.dropdowns.reminders=!0,A())}}else _.remove(e.reminders,function(e){return e.auto})}function $(){t.projectModal&&t.projectModal.remove(),t.userModal&&t.userModal.remove(),t.priorityModal&&t.priorityModal.remove(),t.dueDateModal&&t.dueDateModal.remove()}var N=!1;t.dropdowns={watchers:!1,labels:!1,reminders:!0},t.isEmailEnabled=!1,t.defaultReminderChannels=null,t.toggleMenu=function(e){t.dropdowns[e]=!t.dropdowns[e]},t.tabFocus=function(e){9==e.keyCode&&(3==e.target.tabIndex?t.userModal.show():4==e.target.tabIndex?t.toggleMenu("watchers"):5==e.target.tabIndex?t.priorityModal.show():6==e.target.tabIndex?t.toggleMenu("labels"):7==e.target.tabIndex?t.dueDateModal.show():8==e.target.tabIndex&&t.toggleMenu("reminders"))},t.setAssignees=function(){var a=e.defer();return t.assignees=[],t.taskObject.project.id?b.findById(t.taskObject.project.id).then(function(e){e.users.forEach(function(e){e.status===m.status.active&&t.assignees.push(e)}),t.assignees=h.meTopOnList(t.assignees),t.assignees.unshift({_id:0,displayName:"Unassigned"}),a.resolve(t.assignees)}):(t.assignees.push({_id:0,displayName:"Unassigned"}),a.resolve(t.assignees)),a.promise},t.setWatchers=function(e){var a=[];t.taskObject.watchers.length&&!e||(t.taskObject.project.id?b.findById(t.taskObject.project.id).then(function(e){e.users.forEach(function(e){t.taskObject.assignee._id!==e._id&&e.status===m.status.active&&a.push({checked:D(e),watcher:e})}),a=h.meTopOnList(a,"watcher"),console.log(a),t.taskObject.watchers=angular.copy(a)}):t.taskObject.watchers=angular.copy(a))},t.setReminders=function(e,a){var s=[];if(t.taskObject.reminders.length){if(e){var r=angular.copy(t.assignees);r.splice(0,1),t.taskObject.reminders.forEach(function(e){if(r.length){for(var t=0;t<r.length;t++)if(e.assignee._id==r[t]._id){s.push(e);break}}else e.assignee._id==h.getLoggedInId()&&s.push(e)})}else a&&t.taskObject.reminders.forEach(function(e){(e.time.id||!e.time.id&&t.taskObject.recurrence.due_date)&&s.push(e)});t.taskObject.reminders=angular.copy(s),A()}},t.setDueDate=function(){t.taskObject.recurrence={},t.taskObject.hasDueDate=!0,t.dueDateSummary=d.EMPTY,t.setReminders(!1,!0)},t.updateProject=function(e,a){function s(){t.taskObject.project={id:e.id,name:e.name,color:e.color},(r||a)&&(t.taskObject.assignee={},t.setAssignees().then(function(){t.setReminders(!0,!1)}),t.setWatchers(!0))}var r=t.taskObject.project.id!=e.id;if(r&&!a){var n=h.getLoggedInUser();v.checkUserRole(n,m.USER_ROLES.ACTIVE_TASKS,{project:e},!0).then(function(){s()})}else s()},t.updateAssignee=function(e){t.taskObject.assignee={_id:e._id,displayName:e.displayName,displayShortName:e.displayShortName,email:e.email,avatar:e.avatar},t.setWatchers(!0),U(t.taskObject)},t.updatePriority=function(e){t.taskObject.priority=e},t.updateDueDate=function(e){switch(e){case"TODAY":t.taskObject.recurrence={due_date:j.getDateOnly(j.today())};break;case"TOMORROW":t.taskObject.recurrence={due_date:j.getDateOnly(j.tomorrow())};break;case"WEEK":t.taskObject.recurrence={due_date:j.getDateOnly(j.nextWeek())};break;case"MONTH":t.taskObject.recurrence={due_date:j.getDateOnly(j.nextMonth())};break;case"NO_DATE":t.dueDateModal.show();break;case"CUSTOM_DATE":t.taskObject.recurrence={due_date:t.taskObject.recurrence.due_date}}t.taskObject.hasDueDate=!0,t.dueDateSummary=o.getSummary(t.taskObject.recurrence),U(t.taskObject),t.setReminders(!1,!0)},t.addReminder=function(e){e&&(t.taskObject.reminders.push(t.reminderObject),t.dropdowns.reminders=!0,A()),t.reminderObject={}},t.removeReminder=function(e){var a=O.infoMessages.REMINDER_DELETE_CONFIRMATION;r.show({title:a.title,template:a.message,scope:t,buttons:[{text:d.NO,onTap:function(){return!0}},{text:d.YES,onTap:function(){for(var a=0;a<t.taskObject.reminders.length;a++)if(t.taskObject.reminders[a].id==e){t.taskObject.reminders.splice(a,1);break}A()}}]})},t.getRecurrenceModel=function(e){e?(t.taskObject.recurrence=e,t.taskObject.hasDueDate=!0,t.taskObject.recurrence=o.setDueDate(t.taskObject.recurrence),t.dueDateSummary=o.getSummary(t.taskObject.recurrence),t.setReminders(!1,!0)):n(function(){t.dueDateModal.show()})},t.saveKeyEnter=function(e){13==e.keyCode&&t.save()},t.save=function(){t.form.$submitted=!0,t.form.$valid&&i.add(t.taskObject).then(function(e){e&&(M(),a.$emit("toast-message",O.successMessages.TASK_SAVED),k.taskHome(t.taskObject))})},t.discardPopup=function(e,t){y.discard(a).then(function(a){return!a||(M(),void c.go(e.name,t))})},t.start=function(){t.taskObject=i.getTaskObject();var e=h.getLoggedInUser();v.checkUserRole(e,m.USER_ROLES.EMAIL_NOTIFICATIONS,{},!1).then(function(){t.isEmailEnabled=!0}),v.checkUserRole(e,m.USER_ROLES.ACTIVE_TASKS,{project:t.taskObject.project},0!=t.taskObject.project.id).then(null,function(){}).finally(function(){var e=S.getSettings();t.defaultReminderChannels=e.reminder.taskCreateReminderNotificationChannels,t.reminderObject={},t.title="Add Task",a.addUrl="#/task/add",a.noteUrl="#/task/note/",I(),t.setAssignees(),w(),t.setWatchers(),R(),t.dueDateSummary=o.getSummary(t.taskObject.recurrence),t.loginId=h.getLoggedInId(),t.userId=h.getLoggedInId(),T(),u.setAddTaskHeader(t),a.$emit("task:header"),a.taskSaved&&n(function(){t.save(),a.taskSaved=!1})})},t.start();var L=a.$on("$stateChangeStart",function(e,a,s){t.taskObject&&(E(t.taskObject),"/task/note"!==a.name?!N&&i.taskObjectHasValue()?(e.preventDefault(),t.discardPopup(a,s)):(M(),$()):$())});t.$on("$destroy",function(){C(),L()});var C=a.$on("projectList-update",function(){t.taskObject.project.id&&b.findById(t.taskObject.project.id).then(function(e){e&&t.updateProject(e,!0)})})}])}).call(this);