(function(){app.controller("noteTaskController",["$rootScope","$scope","$stateParams","$ionicScrollDelegate","$state","$ionicModal","userModel","$ionicPopup","$timeout","stringService","taskService","dbEnums","headerService","guidGenerator","noteService","date","sharedData","message","connectivity","$location","uiHelperService","popupService","roleValidators","CONSTANT","$q",function(e,t,o,s,n,a,i,c,d,l,r,u,g,f,m,p,k,I,h,E,T,N,O,S,b){function v(){a.fromTemplateUrl("html/views/modals/file_upload.html",function(e){t.fileUploadModal=e},{scope:t,animation:"scale-in"}),a.fromTemplateUrl("html/views/modals/progress_bar.html",function(e){t.progressBarModal=e},{scope:t,animation:"scale-in"})}t.selected=[],t.noteIds=[],console.log("note task controller"),t.canUploadFile=!1,t.loadingText="Uploading...",t.openFileUpload=function(){var o=i.getLoggedInUser();console.log("file uploading...."),console.log(o),O.checkUserRole(o,u.USER_ROLES.FILE_UPLOAD,{},!0).then(function(){h.isConnected()?t.fileUploadModal.show():e.$emit("toast-message",I.errorMessages.CONNECTION_REQUIRED)})},t.resetTaskObject=function(){t.note={},r.clearTaskObject()},t.noteListFormat=function(){t.taskObject.notes.forEach(function(e){e.dateModified=p.getDateTime(e.date_modified),e.selected=!1})},t.setNoteForm=function(){t.note={id:f.getId(),updatedBy:i.getLoggedInUser(),description:l.EMPTY,status:u.status.active,editable:!1,position:-1},t.selected=[],t.noteIds=[],t.isSelect=!1},t.editForm=function(){t.note=angular.copy(t.selected[0]),t.note.editable=!0,t.isSelect=!1},t.editNote=function(){var o={taskId:t.taskId,note:t.note};m.edit(o).then(function(t){e.$emit("toast-message",I.successMessages.NOTE_EDITED)})},t.addNote=function(){var o={taskId:t.taskId,note:t.note};m.add(o).then(function(o){d(function(){t.$broadcast("scroll.refreshComplete"),d(function(){s.$getByHandle("noteScroll").scrollBottom(!0)})},200),e.$emit("toast-message",I.successMessages.NOTE_SAVED)})},t.save=function(){r.setTaskObject(t.taskObject),t.taskObject.name?r.add(t.taskObject).then(function(o){o&&(t.resetTaskObject(),e.$emit("toast-message",I.successMessages.TASK_SAVED),k.home())}):(e.taskSaved=!0,n.go("/task/add"))},t.saveNote=function(){t.note.description&&(t.note.date_modified=Date.now(),t.taskId&&(t.note.editable?t.editNote():t.addNote()),t.taskId||(t.note.dateModified=p.getDateTime(t.note.date_modified),t.taskObject.notes.push(t.note)))},t.$on("taResize",function(e,t){d(function(){var e=document.body.querySelector(".bar-stable");if(t){var o=t[0].offsetHeight;if(e){var s=o+10;s=s>44?s:44,e.style.height=s+"px"}}})}),t.setFooterPermission=function(){for(var e=t.selected.length>1,o=t.selected[0].isFile,s=0;s<t.selected.length;s++){var n=t.selected[s].updatedBy._id===i.getLoggedInId();if(!n)break}t.copyPermission=!o&&!e,t.editPermission=!o&&!e&&n,t.deletePermission=n},t.clicked=function(e,o){var s=t.selected.indexOf(e);s>-1?(t.selected.splice(s,1),t.noteIds.splice(s,1),e.selected=!1,e.position=-1):(t.selected.push(e),t.noteIds.push(e.id),e.position=o,e.selected=!0),t.selected.length<=0?t.setNoteForm():(t.isSelect=!0,t.setFooterPermission())},t.start=function(){function a(a){a?(t.taskObject=a,t.title=a.name,t.disableModification=a.status==u.status.complete,t.setNoteForm(),t.noteListFormat(),e.$emit("task:header",n.current.state,a),d(function(){if(a.notes.length>0){var e=a.notes[a.notes.length-1].id;o.focusMe?(e=o.focusMe,T.focusTo(e,s.$getByHandle("noteScroll"))):T.scrollTo(e,s.$getByHandle("noteScroll"))}},200)):k.home()}e.rightDefaultViewVisible&&e.$emit("set-page","Task_Notes");var c=i.getLoggedInUser();O.checkUserRole(c,u.USER_ROLES.FILE_UPLOAD,{},!1).then(function(){t.canUploadFile=!0}),o.id?(t.taskId=o.id,t.addUrl="#/task/edit/"+o.id,t.noteUrl="#/task/note/"+o.id,r.findActiveTaskById(t.taskId).then(function(o){o?a(o):e.closedTask?a(e.closedTask):r.getTaskFromServer(t.taskId).then(function(t){t?a(t):e.$emit("toast-message",I.errorMessages.TASK_NOT_FOUND)},function(t){e.$emit("toast-message",t.msg)})})):(t.title="Add Note",t.taskObject=r.getTaskObject(),t.addUrl="#/task/add",t.noteUrl="#/task/note/",t.setNoteForm(),t.noteListFormat(),e.$emit("task:header")),v(),g.setTaskNoteHeader(t,o.id)},t.start(),t.uploadNoteFile=function(o){var n={file:o,id:f.getId(),updatedBy:i.getLoggedInUser(),parent:t.taskId},a=b(function(e,t){var s=i.getLoggedInUser();O.checkUserRole(s,u.USER_ROLES.FILE_STORAGE_MAX,{file:o},!0).then(e,t)});a.then(function(){t.progressBarModal.show(),m.uploadNote(n).then(function(o){o.error||(t.setNoteForm(),t.noteListFormat(),s.$getByHandle("noteScroll").scrollBottom(!0)),o&&o.results&&o.results.errors&&"LICENSE"==o.results.errors.key?N.roleWarning(null,o.results.errors).then(function(){window.cordova?$window.open(encodeURI(S.upgradeUrl),"_system","location=no"):$window.open(S.upgradeUrl,"_blank"),console.log("UPGRADE code goes here")},function(){console.log("UPGRADE CANCEL code goes here")}):e.$emit("toast-message",o.msg),t.progressBarModal.hide()})},function(t){!t||t.key&&"LICENSE"==t.key||e.$emit("toast-message",results.msg)})},t.onFileSelected=function(e){if(t.fileUploadModal.hide(),console.log(e),console.log("getting files..."),e&&e.length){var o=e[0],s=i.getLoggedInUser();O.checkUserRole(s,u.USER_ROLES.FILE_UPLOAD_SIZE,{file:o},!0).then(function(){for(var o=0;o<e.length;o++){var s=e[o];t.uploadNoteFile(s)}})}},t.deleteNote=function(){var o;o=t.selected[1]?I.infoMessages.MULTIPLE_NOTES_DELETE_CONFIRMATION:t.selected[0].isFile?I.infoMessages.SINGLE_FILE_DELETE_CONFIRMATION:I.infoMessages.SINGLE_NOTE_DELETE_CONFIRMATION,c.show({title:o.title,template:o.message,scope:t,buttons:[{text:l.NO,onTap:function(){return!0}},{text:l.YES,onTap:function(){if(t.taskId){t.note=angular.copy(t.selected[0]);var o={taskId:t.taskId,noteIds:t.noteIds};console.log(t.noteIds),m.delete(o).then(function(t){e.$emit("toast-message",I.successMessages.NOTE_DELETED)})}else{var s=t.taskObject.notes.indexOf(t.selected[0]);s>-1&&t.taskObject.notes.splice(s,1),t.setNoteForm(),t.noteListFormat(),t.selected=[],t.noteIds=[],t.isSelect=!1}}}]})},t.discardPopup=function(e,o){c.show({template:I.infoMessages.DISCARD_CHANGE.message,title:I.infoMessages.DISCARD_CHANGE.title,scope:t,buttons:[{text:l.NO,onTap:function(){return!0}},{text:l.YES,onTap:function(){t.resetTaskObject(),n.go(e.name,o)}}]})},t.copyNote=function(){e.$emit("toast-message",I.successMessages.NOTE_COPIED),t.copiedNote=angular.copy(t.selected[0].description),t.selected=[],t.noteIds=[],t.isSelect=!1,t.noteListFormat()};var L=e.$on("taskList-update",function(){r.findById(t.taskId).then(function(e){e&&(t.taskObject=e,t.setNoteForm(),t.noteListFormat())})});t.$on("$stateChangeStart",function(e,o,s){"/task/add"===o.name||"/task/edit"===o.name?r.setTaskObject(t.taskObject):(!t.taskId&&r.taskObjectHasValue()||t.note.description)&&(e.preventDefault(),t.discardPopup(o,s))}),t.toggleTab=function(t){var o=e.$broadcast("default:tabswitch");o.defaultPrevented?o.promise&&o.promise.then(function(e){e&&switchTab(t)}):switchTab(t)},t.$on("$destroy",L)}])}).call(this);