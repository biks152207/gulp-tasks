(function(){app.controller("inviteProjectController",["$rootScope","$scope","$state","$ionicPopup","$stateParams","project","sharedData","message","stringService","dbEnums","userModel","roleValidators",function(e,t,n,i,o,s,r,a,c,d,l,p){function u(e){for(var n=null,i=0;i<t.allUsers.length;i++)if(t.allUsers[i].email==e){n=t.allUsers[i];break}n||(n={email:e,displayName:e,displayShortName:c.firstLetter(e)});var o=s.getProjectAdmin(t.project)._id===l.getLoggedInId();return n.isInviterAdmin=o,n.invitedBy=l.getLoggedInId(),n.role=o?d.projectUserRole.pending:d.projectUserRole.approval,n.invitationPending=!0,n.isAdmin=!1,n}function g(e,t){for(var n=0;n<e.users.length;n++)if(e.users[n].email===t)return!0;return!1}function m(n,i){switch(n){case f.send:s.sendInvitation(t.project,u(t.invitation.email)).then(function(){t.form.$setPristine(),t.form.$setUntouched(),t.invitation={}});break;case f.resend:var o={projectId:t.project.id,user:i};s.reSendInvitation(o).then(function(t){e.$emit("toast-message",t.message)});break;case f.cancel:s.deleteUser(t.project,i).then(function(){e.$emit("toast-message",a.successMessages.PROJECT_INVITATION_CANCELLED)});break;case f.remove:s.deleteUser(t.project,i).then(function(){e.$emit("toast-message",a.successMessages.PROJECT_USER_DELETED)})}}var f={send:"send",resend:"resend",cancel:"cancel",remove:"remove"};t.invitationPopUp=function(e,n,o){i.show({title:n.title,template:n.message,scope:t,buttons:[{text:c.NO,type:"btn-no",onTap:function(){return t.form.$submitted=!1,!0}},{text:c.YES,type:"btn-yes",onTap:function(){m(e,o)}}]})},t.save=function(){if(t.form.$submitted=!0,t.form.$valid)if(t.invitation.email=t.selectedUser?t.selectedUser.originalObject.email:t.form.iEmail.$$rawModelValue,console.log(t.invitation.email),g(t.project,t.invitation.email))t.form.$setPristine(),t.form.$setUntouched(),t.invitation={},e.$emit("toast-message",a.errorMessages.EMAIL_ALREADY_EXISTS);else{var n=l.getLoggedInUser();p.checkUserRole(n,d.USER_ROLES.MAX_USERS_PROJECT,{project:t.project},!0).then(function(){var e=s.getProjectUserById(t.project,l.getLoggedInId());t.invitationPopUp(f.send,e.isAdmin?a.infoMessages.PROJECT_INVITATION_SENT_BY_ADMIN:a.infoMessages.PROJECT_INVITATION_SENT_BY_USER)})}},t.deleteUser=function(e){t.invitationPopUp(f.remove,a.infoMessages.PROJECT_USER_DELETED,e)},t.reSendInvitation=function(e){t.invitationPopUp(f.resend,a.infoMessages.PROJECT_INVITATION_RESENT,e)},t.deleteInvitation=function(e){t.invitationPopUp(f.cancel,a.infoMessages.PROJECT_INVITATION_CANCELLED,e)},t.start=function(){s.findById(o.id).then(function(i){i?(t.project=i,t.project.users=l.adminTopOnList(t.project.users),t.invitation={},e.title="Invite: "+t.project.name,t.loginId=l.getLoggedInId(),t.canDeleteUser=s.canDeleteUser(i,l.getLoggedInUser()),e.$emit("basic:header",n.current.state,t.project,t,!0,"Send")):r.home()}),s.getAllProjectsUsers().then(function(e){t.allUsers=e})},t.start();var I=e.$on("projectList-update",function(){s.findById(o.id).then(function(e){e&&(t.project=e)})});t.$on("$destroy",function(){I()}),t.searchInputFocus=function(){var e=l.getLoggedInUser();e&&p.checkUserRole(e,d.USER_ROLES.MAX_USERS_PROJECT,{project:t.project,invitedUser:invitedUser},!0)}}])}).call(this);