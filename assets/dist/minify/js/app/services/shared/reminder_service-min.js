(function(){app.service("reminderService",["$cordovaLocalNotification","$rootScope","$state","taskService","date","reminderModel","$interval","message","userModel","dbEnums","$q","CONSTANT",function(e,i,t,n,d,r,a,o,s,u,c,l){function f(i,t,n){p[t.id]?e.update({id:p[t.id].UID,at:n,text:i.recurrence.due_date?"Due: "+d.getDateTime(i.recurrence.due_date):o.infoMessages.NO_DUE_DATE_SET.message,title:"Reminder: "+i.name}).then(function(){console.log("The notification has updated")}):(t.UID=g(),E[t.UID]=!0,p[t.id]=t,e.schedule({id:t.UID,icon:"res://ic_stat_onesignal_default",at:n,text:i.recurrence.due_date?"Due: "+d.getDateTime(i.recurrence.due_date):o.infoMessages.NO_DUE_DATE_SET.message,title:"Reminder: "+i.name,data:JSON.stringify({taskId:i.id,reminderId:t.id})}).then(function(){console.log("The notification has been set")}))}function m(e,i,t){i.taskId=e.id,i.scheduleTime=t,r.addOrUpdate(i,function(){})}function g(){var e;do e=parseInt(1e7*Math.random());while(E[e]);return e}function h(){return("android"===T||"ios"===T)&&window.cordova}function v(){s.isAuthenticated()&&r.getAll(function(e,i){var t=new Date,a=new Date;a.setMinutes(t.getMinutes()+1),i.forEach(function(e){d.isInRange(t,a,e.scheduleTime)&&n.findById(e.taskId).then(function(i){var t,a="Reminder: "+i.name;t=i.recurrence.due_date?"Due:  "+d.getDateTime(i.recurrence.due_date):o.infoMessages.NO_DUE_DATE_SET.message,console.log("Reminder: Task - "+i.name+" :::: Reminder id - "+e.id),I(e,a,t),n.reminderDeleted(i.id,e.id),r.delete(e.id,function(){})})})})}function I(e,i,t){console.log(i+" :::: Reminder id - "+e.id);({state:"/task/edit",params:e.taskId});notify.createNotification(i,{body:t,icon:l.iconUrl}),R.play()}function D(e){var i=s.getLoggedInId();e.reminders.forEach(function(t){if(i==t.assignee._id){var a=k.getScheduledTime(t,e.recurrence.due_date);d.isPast(a)&&t.notificationChannels.push.value&&(console.log("cleaning up reminder for task : "+e.name),n.reminderDeleted(e.id,t.id),r.delete(t.id,function(){}))}})}var T=ionic.Platform.platform(),p=[],k=this,E=[],R=new Audio("media/sound/notification.mp3");k.notificationChannels={email:{title:"Email",value:!0,notified:!1},push:{title:"Push",value:!1,notified:!0}},k.timeDuration=[{title:"0 minutes before",value:9,minutes:0},{title:"5 minutes before",value:0,minutes:5},{title:"15 minutes before",value:1,minutes:15},{title:"30 minutes before",value:2,minutes:30},{title:"1 hour before",value:3,minutes:60},{title:"2 hours before",value:4,minutes:120},{title:"3 hours before",value:5,minutes:180},{title:"6 hours before",value:6,minutes:360},{title:"12 hours before",value:7,minutes:720},{title:"1 day before",value:8,minutes:1440}],k.init=function(){h()&&e.registerPermission()},k.getScheduledTime=function(e,i){var t;return e.time.id?t=new Date(e.time.value):(t=new Date(i),t.setMinutes(t.getMinutes()-k.timeDuration[e.time.value].minutes)),t},k.addReminder=function(e,i){var t=k.getScheduledTime(i,e.recurrence.due_date);!d.isPast(t)&&i.notificationChannels.push.value&&(h()?f(e,i,t):m(e,i,t))},k.deleteReminder=function(i,t){if(h()){if(!p[t.id])return;e.clear(p[t.id].UID).then(function(){})}else r.delete(t.id,function(){})},k.deleteRemindersByTaskId=function(i){var t=c.defer();if(h()){for(var n in p)if(p.hasOwnProperty(n)&&p[n].taskId==i){if(!p[reminder.id])return;e.clear(p[n].UID).then(function(){})}t.resolve()}else r.deleteRemindersByTaskId(i,function(){t.resolve()});return t.promise},i.$on("reminder:setReminders",function(e,i){var t=s.getLoggedInId();i.status==u.status.active?k.deleteRemindersByTaskId(i.id).then(function(){i.reminders.forEach(function(e){t==e.assignee._id&&k.addReminder(i,e)})}):i.reminders.forEach(function(e){t==e.assignee._id&&k.deleteReminder(i,e)})}),h()?(window.cordova.plugins.notification.local.on("trigger",function(i){console.log("reminder triggered.");var t=JSON.parse(i.data);n.reminderDeleted(t.taskId,t.reminderId),r.delete(t.reminderId,function(){}),e.clear(i.id).then(function(){})}),i.$on("$cordovaLocalNotification:click",function(i,d,a){var o=JSON.parse(d.data);n.reminderDeleted(o.taskId,o.reminderId).then(function(){t.go("/task/edit",{id:o.taskId})}),r.delete(o.reminderId,function(){}),e.clear(d.id).then(function(){})})):a(v,6e4),k.cleanUpReminders=function(){n.getAll().then(function(e){_.forEach(e,function(e){e.status==u.status.active&&D(e)})})}}])}).call(this);