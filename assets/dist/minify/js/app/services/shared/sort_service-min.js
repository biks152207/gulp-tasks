(function(){app.service("sortService",["$window","stringService","filterService","$rootScope","$q","$state","settingsService","sync","dbEnums","userModel",function(e,t,r,n,o,a,i,s,l,u){function S(e,t){s.add(l.collections.Settings,{sortOption:t,sortKey:e,userId:u.getLoggedInId()},l.events.Settings.sortUpdate)}function c(e){var t=f.SORTS,r=_.find(t,function(t,r){return t.value==e});return r}function T(e){var t=_.find(f.ORDERS,function(t,r){return t.value==e});return t}var f=this;f.DEFAULT_ORDER={name:"DESC",value:"desc"},f.DEFAULT_SORT={name:"Due date",value:"due",showDateBar:!0},f.FILTER_TYPE={DEFAULT:"Filter",CUSTOM:"My Filters"},f.FILTERS=[{name:"Inbox",value:"inbox",type:f.FILTER_TYPE.DEFAULT},{name:"Today",value:"today",type:f.FILTER_TYPE.DEFAULT},{name:"Next 7 days",value:"next7days",type:f.FILTER_TYPE.DEFAULT},{name:"Overdue",value:"overdue",type:f.FILTER_TYPE.DEFAULT},{name:"Favourites",value:"favourites",type:f.FILTER_TYPE.DEFAULT},{name:"Watching",value:"watching",type:f.FILTER_TYPE.DEFAULT}],f.SORTS=[{name:"Due date",value:"due",showDateBar:!0},{name:"Priority",value:"priority",showDateBar:!1},{name:"My order",value:"custom",showDateBar:!0},{name:"Plan view",value:"plan",showDateBar:!1}],f.ORDERS=[{name:"Ascending",value:"asc"},{name:"Descending",value:"desc"}],f.getFilterByValue=function(e){for(var t=0;t<f.FILTERS.length;t++)if(f.FILTERS[t].value==e)return f.FILTERS[t];return null},f.getFilterType=function(){return JSON.parse(e.localStorage.getItem("filterType"))},f.getOrder=function(){var e=f.getSortOptionByKey((n.sorts||{}).key||"project"),t=T(e.order);return t},f.getSortType=function(){var e=f.getSortOptionByKey((n.sorts||{}).key||"project"),t=c(e.sort);return t},f.setAll=function(e,t,r){var n=o.defer();return f.setAllFilters(e,t).then(function(){n.resolve()}),n.promise},f.setAllFilters=function(e,t){var a=o.defer(),i=[];return r.getAll().then(function(r){i={list:angular.copy(f.FILTERS)},r.forEach(function(r){var n={name:r.name,value:r.id,type:f.FILTER_TYPE.CUSTOM};i.list.indexOf(n)<=-1&&(i.list.push(n),e!=n.value||t||(i.select=n))}),i.select||t||(i.select=f.getFilterType()),n.filters=i,a.resolve()}),a.promise},f.setAllSorts=function(e){var t=f.getSortOptionByKey(e),r=f.getSortOrdersByKey(e),o=c(t.sort);n.sorts={list:r,select:o,key:e}},f.setAllOrders=function(e){var t=f.getSortOptionByKey(e),r=T(t.order);n.orders={list:f.ORDERS,select:r,key:e}},f.setDefault=function(e,t){f.setFilterTypeByValue(e),t||(f.setOrder(f.DEFAULT_ORDER),f.setSortType(f.DEFAULT_SORT))},f.setFilterTypeByValue=function(e){f.setFilterType(f.getFilterByValue(e))},f.setFilterType=function(r){r=r||t.EMPTY,e.localStorage.setItem("filterType",JSON.stringify(r))},f.setOrder=function(e){var t=i.getSettings();t.sort=t.sort||{},t.sort.order=e.value,i.updateSort(t)},f.setSortType=function(e){var t=i.getSettings();t.sort=t.sort||{},t.sort.sortType=e.value,i.updateSort(t)},n.changeFilter=function(e){switch(f.setFilterType(e),e.type){case f.FILTER_TYPE.DEFAULT:a.go("/task/list/",{type:e.value});break;case f.FILTER_TYPE.CUSTOM:a.go("/filter/details",{id:e.value})}},n.changeOrder=function(e){f.setOrder(e),n.$emit("task:list-sorted")},n.changeSort=function(e){f.setSortType(e),n.$emit("task:list-sorted")},n.$on("$stateChangeSuccess",function(e,t,r,n,o){if(u.isAuthenticated()){var a=t.sortKey;"list"==a&&(a=r.type),a&&(f.setAllSorts(a),f.setAllOrders(a))}}),f.getSortOptionByKey=function(t){var r=e.localStorage.getItem("sortOptions")||"{}",n=JSON.parse(r),o=n[t];return o||(o={sort:f.DEFAULT_SORT_TYPES[t],order:"asc"},n[t]=o,e.localStorage.setItem("sortOptions",JSON.stringify(n)),S(t,o)),o},f.setSortOptionByKey=function(t,r){var n=JSON.parse(e.localStorage.getItem("sortOptions")||"{}");n[t]=r,e.localStorage.setItem("sortOptions",JSON.stringify(n)),S(t,r)},n.changeSortValue=function(e,t){var r=f.getSortOptionByKey(e);r.sort=t,f.setSortOptionByKey(e,r),n.$emit("task:list-sorted")},n.changeSortOrder=function(e,t){var r=f.getSortOptionByKey(e);r.order=t,f.setSortOptionByKey(e,r),n.$emit("task:list-sorted")},f.getSortOrdersByKey=function(e){var t=f.SORT_ORDERS_LIST[e];return t||(t=f.SORT_ORDERS_LIST.default),t},f.DEFAULT_SORT_TYPES={inbox:"due",today:"due",next7days:"due",overdue:"due",watching:"due",favourites:"due",closed:"due",project:"plan",assignee:"due",label:"due",filter:"due"},f.SORT_ORDERS_LIST={inbox:_.filter(f.SORTS,function(e,t){return"plan"!=e.value}),today:_.filter(f.SORTS,function(e,t){return"plan"!=e.value}),next7days:_.filter(f.SORTS,function(e,t){return"plan"!=e.value}),overdue:_.filter(f.SORTS,function(e,t){return"plan"!=e.value}),watching:_.filter(f.SORTS,function(e,t){return"plan"!=e.value}),favourites:_.filter(f.SORTS,function(e,t){return"plan"!=e.value}),closed:_.filter(f.SORTS,function(e,t){return"plan"!=e.value}),project:f.SORTS,assignee:_.filter(f.SORTS,function(e,t){return"plan"!=e.value}),label:_.filter(f.SORTS,function(e,t){return"plan"!=e.value}),filter:_.filter(f.SORTS,function(e,t){return"plan"!=e.value}),filter:_.filter(f.SORTS,function(e,t){return"plan"!=e.value})}}])}).call(this);