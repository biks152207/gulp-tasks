(function(){app.service("dueService",["date","stringService",function(e,t){function a(e,t,a){switch(t.due_date=e,t.repeatEnd.id){case 1:a&&t.repeatEnd.remainingOccurrence--,t.isRecurring=!!t.repeatEnd.remainingOccurrence;break;case 2:var r=new Date(t.repeatEnd.end);r.setDate(r.getDate()+1),r.setHours(0,0,0,0),t.isRecurring=e<r}return t}var r=this;r.REPEAT_BY_ITEMS=[{checked:!1,code:0,name:"day of the month"},{checked:!1,code:1,name:"day of the week"}],r.REPEAT_ITEMS={DAILY:{title:"Daily",plural:"days"},WEEKLY:{title:"Weekly",plural:"weeks"},MONTHLY:{title:"Monthly",plural:"months"},YEARLY:{title:"Yearly",plural:"years"}},r.REPEAT_KEY={DAILY:"DAILY",WEEKLY:"WEEKLY",MONTHLY:"MONTHLY",YEARLY:"YEARLY"},r.REPEAT_ON_ITEMS=[{checked:!1,code:"S",title:"Sunday"},{checked:!1,code:"M",title:"Monday"},{checked:!1,code:"T",title:"Tuesday"},{checked:!1,code:"W",title:"Wednesday"},{checked:!1,code:"T",title:"Thursday"},{checked:!1,code:"F",title:"Friday"},{checked:!1,code:"S",title:"Saturday"}],r.getSummary=function(a){if(a.isRecurring){var n=new Date;a.starts_on=new Date(a.starts_on);var s="";if(s=!a.every||a.every<=1?r.REPEAT_ITEMS[a.repeat].title:"Every "+a.every+" "+r.REPEAT_ITEMS[a.repeat].plural,a.repeat===r.REPEAT_KEY.WEEKLY){var c=0,d="";s+=" on ";for(var E=0;E<a.repeatOn.length;E++)a.repeatOn[E].checked&&(c++,d+=a.repeatOn[E].title+", ");d=7==c?"all days":c>0?d.replace(/,\s*$/,""):e.week[n.getDay()],s+=d}else a.repeat==r.REPEAT_KEY.MONTHLY?s+=a.repeatBy?" on the "+e.weekPrefixes[a.weekNumber]+" "+e.week[a.starts_on.getDay()]:" on day "+a.starts_on.getDate():a.repeat==r.REPEAT_KEY.YEARLY&&(s+=" on "+e.month[a.starts_on.getMonth()]+" "+a.starts_on.getDate());return(a.starts_on.getHours()||a.starts_on.getMinutes())&&(s+=" @ "+e.getTime(a.starts_on)),1==a.repeatEnd.id&&a.repeatEnd.occurrence?s+=", "+a.repeatEnd.occurrence+" times":2==a.repeatEnd.id&&a.repeatEnd.end&&(s+=" until "+e.getDateTime(a.repeatEnd.end)),s}return a.due_date?e.getDateTime(a.due_date):t.EMPTY},r.setDueDate=function(e,t){if(!e.isRecurring)return e;var n;e.starts_on=new Date(e.starts_on),e.due_date=new Date(e.due_date);var s;switch(t?(s=t<e.due_date?new Date(e.due_date):new Date(t),n=e.every):(s=new Date(e.starts_on),n=0),e.repeat){case r.REPEAT_KEY.DAILY:s.setDate(s.getDate()+n);break;case r.REPEAT_KEY.WEEKLY:var c,d=new Date(s),E=!1;c=n?7:14;var i=d.getDay()+1;for(d.setDate(d.getDate()+1);i<c;){if(e.repeatOn[d.getDay()].checked){E=!0,s=d;break}d.setDate(d.getDate()+1),i++}if(!E){var o=new Date(s);for(o.setDate(o.getDate()+7*n-o.getDay()),g=0;g<7;g++){if(e.repeatOn[o.getDay()].checked){s=o;break}o.setDate(o.getDate()+1)}}break;case r.REPEAT_KEY.MONTHLY:var D=s.getMonth()+1*n;s.setMonth(D);var u=new Date(e.starts_on);if(e.repeatBy){s.setDate(1);for(var g=0;g<7&&s.getDay()!=u.getDay();g++)s.setDate(s.getDate()+1);s.setDate(s.getDate()+7*e.weekNumber),s.getMonth()>D&&s.setDate(s.getDate()-7)}else s.setDate(u.getDate());break;case r.REPEAT_KEY.YEARLY:s.setFullYear(s.getFullYear()+1*n),s.setDate(e.starts_on.getDate())}return s.setHours(e.starts_on.getHours()),s.setMinutes(e.starts_on.getMinutes()),a(s,e,t)}}])}).call(this);