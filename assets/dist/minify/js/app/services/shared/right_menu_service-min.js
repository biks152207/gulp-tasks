(function(){app.service("rightMenuService",["$rootScope","$state","project","user","dbEnums","message","sharedData","date","notificationService","userModel","$ionicPopup","stringService","CONSTANT","$ionicModal","$ionicLoading","roleValidators","sync","RESPONSE_CODE","connectivity","$http","API",function(e,t,s,o,i,n,a,r,c,E,l,T,u,p,I,m,R,d,f,O,N){function g(t,o){l.show({title:n.infoMessages.PROJECT_ARCHIVED_CONFIRMATION.title,template:n.infoMessages.PROJECT_ARCHIVED_CONFIRMATION.message,scope:o,buttons:[{text:T.NO,type:"btn-no",onTap:function(){return!0}},{text:T.YES,type:"btn-yes",onTap:function(){s.archive(t).then(function(){e.$emit("toast-message",n.successMessages.PROJECT_ARCHIVED),a.home()})}}]})}function h(e,t){t.copy=function(){t.copyTaskLinkModal.remove()},p.fromTemplateUrl("html/views/modals/copy-task-link.html",function(s){t.copyTaskLinkModal=s,t.link=u.app_link+"/#/task/edit/"+e.id,t.modalTitle=n.infoMessages.LINK_TO_TASK_CONFIRMATION.title,t.modalDescription=n.infoMessages.LINK_TO_TASK_CONFIRMATION.message,t.copyTaskLinkModal.show()},{scope:t,animation:"scale-in"})}function S(e,t){var o=E.getLoggedInUser(),i=s.canDeleteProject(e,o);i?A(e,t):l.show({title:n.infoMessages.PROJECT_DELETED_DISALLOWED.title,template:n.infoMessages.PROJECT_DELETED_DISALLOWED.message,scope:t,buttons:[{text:T.OK,type:"btn-ok",onTap:function(){return!0}}]})}function A(t,o){l.show({title:n.infoMessages.PROJECT_DELETED_CONFIRMATION.title,template:n.infoMessages.PROJECT_DELETED_CONFIRMATION.message,scope:o,buttons:[{text:T.NO,type:"btn-no",onTap:function(){return!0}},{text:T.YES,type:"btn-yes",onTap:function(){s.delete(t).then(function(){e.$emit("toast-message",n.successMessages.PROJECT_DELETED),a.home()})}}]})}function C(t,o){l.show({title:n.infoMessages.PROJECT_LEFT_CONFIRMATION.title,template:n.infoMessages.PROJECT_LEFT_CONFIRMATION.message,scope:o,buttons:[{text:T.NO,type:"btn-no",onTap:function(){return!0}},{text:T.YES,type:"btn-yes",onTap:function(){s.left(t).then(function(){e.$emit("toast-message",n.successMessages.PROJECT_LEFT),a.home()})}}]})}function L(e,t,s,o,n){function a(e){var t=[];return e.length>0&&(e.forEach(function(e){e.date=r.getDateTimeFromNow(e.date_created),e.isProject?e.redirectTo=e.isProjectDeleted?"#/":"#/project/details/"+e.project.id:e.isNote?e.redirectTo="#/task/note/"+e.task.id+"?focusMe="+(e.note?e.note.id:""):e.isCompleted?e.redirectTo="#/task/closed?tasks="+e.task.id:e.redirectTo="#/task/edit/"+e.task.id,e.task&&e.task.status&&e.task.status==i.status.deleted&&(e.redirectTo="javascript:void(0)"),e.isNote&&e.isCompleted,e.markAsUnread=!e.seen,t.push(e)}),t=_.orderBy(t,"date_created","desc"),c.items.concat(t),t.forEach(function(e){c.items.push(e)})),t}var c=this;c.skip=0,this.limit=25,c.initialData=n||[],c.items=[],this.loadMore=function(){console.log("loadMore : "+moment().format("hh:mm:ss:sss")),0===c.skip?(c.initialData.length>0?(a(c.initialData),c.skip+=c.initialData.length):c.noMoreItemsAvailable=!0,o.$broadcast("scroll.infiniteScrollComplete"),console.log("loadMore ends : "+moment().format("hh:mm:ss:sss"))):t.getAllNotificationsByUserId(c.skip,c.limit).then(function(e){e.length?(a(e),c.skip+=e.length):c.noMoreItemsAvailable=!0,console.log("loadMore ends : "+moment().format("hh:mm:ss:sss")),o.$broadcast("scroll.infiniteScrollComplete")})},this.loadMore()}function M(t){var s=e.$new();l.show({title:n.infoMessages.PROJECT_ADMIN_REQUEST_CONFIRMATION.title,template:n.infoMessages.PROJECT_ADMIN_REQUEST_CONFIRMATION.message,scope:s,buttons:[{text:T.NO,type:"btn-no",onTap:function(){return!0}},{text:T.YES,type:"btn-yes",onTap:function(){v(t)}}]})}function v(t){var s=e.$new();s.project=t,s.sendProjectAdminRequest=k.sendProjectAdminRequest,s.removeProjectAdminRequestDetailModal=D,s.model={},p.fromTemplateUrl("html/views/modals/project/project_admin_request_details.html",function(e){J=e,s.project=t,J.show()},{scope:s,animation:"scale-in"})}function D(e){J.remove(),e.preventDefault()}var k=this,P={DELETE:"DELETE",REMINDER:"REMINDER"},b={ARCHIVE:"ARCHIVE",DELETE:"DELETE",EDIT:"EDIT",HELP:"HELP",INVITE_USERS:"INVITE_USERS",LEAVE:"LEAVE",LINK:"LINK",LOGOUT:"LOGOUT",NOTIFICATION:"NOTIFICATION",REFRESH:"REFRESH",SEARCH:"SEARCH",SETTINGS:"SETTINGS",VIEW_USERS:"VIEW_USERS",PROJECT_ADMIN_REQUEST:"PROJECT_ADMIN_REQUEST"},y=[],U={FILTER:"filter",LABEL:"label",PROJECT:"project",TASK:"task"};k.getMenu=function(){return y},k.getBottomMenu=function(){return[{title:"Reminder",value:P.REMINDER},{title:"Delete",value:P.DELETE}]},k.itemClicked=function(s,n,a,r){switch(s.value){case b.ARCHIVE:g(n,a);break;case b.DELETE:s.type==U.FILTER||s.type==U.LABEL||s.type==U.PROJECT&&S(n,a);break;case b.EDIT:var c;s.type==U.FILTER?c="/filter/edit":s.type==U.LABEL?c="/label/edit":s.type==U.PROJECT&&(c="/project/edit"),t.go(c,{id:n.id});break;case b.HELP:break;case b.INVITE_USERS:var l=E.getLoggedInUser();m.checkUserRole(l,i.USER_ROLES.MAX_USERS_PROJECT,{project:n.id},!0),t.go("/project/invite",{id:n.id});break;case b.LEAVE:C(n,a);break;case b.LINK:h(n,a);break;case b.LOGOUT:o.logout();break;case b.NOTIFICATION:k.openNotificationBar(r,a);break;case b.REFRESH:I.show();var T=e.$on("pull-from-server-complete",function(){T(),I.hide()});e.$emit("push-to-server",!0);break;case b.SEARCH:e.$emit("attach-focus","search-box");break;case b.SETTINGS:t.go("/settings");break;case b.VIEW_USERS:t.go("/project/users",{id:n.id});break;case b.PROJECT_ADMIN_REQUEST:M(n)}},k.openNotificationBar=function(e,t){moment();c.getNotifications().then(function(s){if(t.items=[],s.length){var o=new L(t.notificationBar,c,e,t,s);t.notification=o,t.notificationBar.show(e).then(function(){}),c.seenNotifications()}})},k.setMenu=function(e,t){if(y=[{title:"Refresh",value:b.REFRESH},{title:"Notifications",value:b.NOTIFICATION,isNotification:!0},{title:"Settings",value:b.SETTINGS}],e)switch(e){case U.FILTER:break;case U.LABEL:break;case U.PROJECT:y.push({title:"Edit project",value:b.EDIT,type:U.PROJECT}),y.push({title:"View users",value:b.VIEW_USERS}),y.push({title:"Invite user to project",value:b.INVITE_USERS}),y.push({title:"Archive project",value:b.ARCHIVE});var o=t?s.getUserRole(t,E.getLoggedInId()):T.EMPTY;t?t.users:[];if(o==i.projectUserRole.admin){var n={title:"Make another user Project Admin",value:b.PROJECT_ADMIN_REQUEST,type:U.PROJECT};y.push(n);var a={title:"Delete project",value:b.DELETE,type:U.PROJECT,disabled:!s.canDeleteProject(t)};y.push(a)}else y.push({title:"Leave project",value:b.LEAVE,type:U.PROJECT});break;case U.TASK:y.push({title:"Link to task",value:b.LINK,type:U.TASK})}y.push({title:"Help",value:b.HELP}),y.push({title:"Logout",value:b.LOGOUT})};var J;k.sendProjectAdminRequest=function(t,s,o){var i=_.find(s.users,function(e){return e.email==o.email});if(!i)return l.alert({title:n.errorMessages.PROJECT_ADMIN_INVITATION_INVALID_PROJECT_USER.title,content:n.errorMessages.PROJECT_ADMIN_INVITATION_INVALID_PROJECT_USER.message,buttons:[{text:T.OK,onTap:function(){return!1}}]}),!1;J.remove();var a=E.getLoggedInUser();a.password=o.password;var r={project:s,user:a,newAdmin:o.email};f.isConnected()?O.post(N.project.adminInvitation,r).success(function(t){t.response_code===d.SUCCESS?e.$emit("toast-message",n.successMessages.PROJECT_ADMIN_INVITATION_SENT):t.response_code===d.ERROR&&t.errors.message&&e.$emit("toast-message",{title:t.errors.message})}).error(function(t){e.$emit("toast-message",{title:t.message})}):e.$emit("toast-message",n.errorMessages.CONNECTION_ERROR),console.log(s)}}])}).call(this);