(function(){app.service("sync",["$q","$window","$http","$rootScope","API","connectivity","TodoZuDB","$timeout","projectModel","filterModel","labelModel","settingsModel","taskModel","userModel","notificationModel",function(e,t,s,n,o,r,i,c,l,a,u,f,p,d,g){function m(t){var n=e.defer();return r.isConnected()?s.post(o.sync.push,t).success(function(e){n.resolve(!0)}).error(function(e){console.log("pushing error",e),n.resolve(!1)}):n.resolve(!1),n.promise}var v=this,h=!1,b=!1,k=!1;v.clearInstance=function(){var e=i.getDb().open(i.name,i.version);e.onsuccess=function(){var t=e.result,s=t.transaction("changes","readwrite");s.objectStore("changes").clear(),t.close()}},v.add=function(e,t,s){var o={collectionName:e,object:t,type:s,timestamp:Date()},r=i.getDb().open(i.name,i.version);r.onsuccess=function(){var e=r.result,t=e.transaction("changes","readwrite"),s=t.objectStore("changes");s.put(o),h=!0,n.$emit("push-to-server"),e.close()}},n.$on("push-to-server",function(e,t,s){c(function(){if(h&&!b){b=!0;var e=[],o=i.getDb().open(i.name,i.version);o.onsuccess=function(){var r=o.result,i=r.transaction("changes","readwrite"),c=i.objectStore("changes");c.openCursor().onsuccess=function(o){var r=o.target.result;r?(e.push(r.value),r.continue()):m(e).then(function(e){e&&(h=!1,t&&n.$emit("pull-from-server",s),v.clearInstance()),b=!1})},r.close()}}else t&&n.$emit("pull-from-server")},500)}),n.$on("pull-from-server",function(e){if(r.isConnected()&&!h&&!k&&d.isAuthenticated()){k=!0;var t={id:d.getLoggedInId(),timestamp:d.getLastPullTimestamp()};s.post(o.sync.pull,t).success(function(e){console.log("pull success");var t=e.data;d.setLastPullTimestamp(new Date),t.features&&d.saveUserFeatures(t.features),t.licenseFeatures&&d.saveAllFeatures(t.licenseFeatures),t.settings&&(f.addOrUpdate(t.settings,function(){}),t.settings.filterView&&f.setAllFilterViews(t.settings.filterView),t.settings.sortOption&&f.setAllSortOptions(t.settings.sortOption)),t.projects.length&&l.bulkUpdate(t.projects,function(){}),t.labels.length&&u.bulkUpdate(t.labels,function(){}),t.filters.length&&a.bulkUpdate(t.filters,function(){}),t.tasks.length&&p.bulkUpdate(t.tasks,function(){}),t.taskCustomOrders&&t.taskCustomOrders.length&&d.changeTaskSortOrder(t.taskCustomOrders,function(){}),t.notifications&&t.notifications.length>0&&g.bulkUpdate(t.notifications,function(){}),k=!1}).error(function(e){console.log("pull error",e),k=!1}).finally(function(){n.$emit("pull-from-server-complete")})}else n.$emit("pull-from-server-complete")})}])}).call(this);