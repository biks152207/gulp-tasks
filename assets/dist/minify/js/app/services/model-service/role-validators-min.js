!function(){app.service("roleValidators",["$q","projectModel","popupService","CONSTANT","dbEnums","userModel","taskModel","labelModel","helperService","$window","connectivity","userModelHelper",function(e,n,t,r,i,o,u,c,s,a,f,l){function d(n,t){return e(function(e,r){var o=u.getTaskUserByRole(t,i.taskUserRole.assignee);o&&n._id==o._id?r({shouldSkip:!0}):e()})}function v(n,t,r){var i=e.defer(),u=o.getUserFeatures(),c=e(function(e,n){e()});return c=c.then(function(e){return L(u,t)}).then(i.resolve,function(e){e&&e.shouldSkip?i.resolve():i.reject(e)}),i.promise}function g(n){return e(function(e,t){h(n).then(function(n){n?e():t({shouldSkip:!0})},t)})}function h(n){return e(function(e,t){u.findById(n.id,function(r,i){if(r)t(r);else if(i){var o=i.project.id!=n.project.id;e(o)}else e(!0)})})}function p(n,t){return e(function(e,r){c.getAll(function(i,o){if(i)r(i);else{var u=_.filter(o,function(e){return(e.tasks||[]).indexOf(t)>=0}),c=_.map(u,function(e){return e.id}),s=_.map(n||[],function(e){return e.id}),a=!1;_.each(s,function(e){var n=_.indexOf(c,e)>=0;if(!n)return a=!0,!1}),e(a)}})})}function k(n,t){return e(function(e,r){var o=s.getUserByRole(t.users,i.taskUserRole.assignee);o?u.findById(t.id,function(c,s){if(c)r(c);else if(s){var a=u.getTaskUserByRole(s,i.taskUserRole.assignee);a?s.project.id!=t.project.id?e():a._id!=o._id&&o._id!=n._id?e():r({shouldSkip:!0}):e()}else e()}):r({shouldSkip:!0})})}function m(t,r,i){return e(function(e,o){t&&"LICENSE"==t.key&&t.isLicense?0==i.id?(t.skipUpgrade=!0,e(t)):n.findById(i.id,function(n,i){var o=S(r,i);t.skipUpgrade=!o,e(t)}):e(err)})}function S(e,n){var t=0==n.id;if(t)return!0;var r=_.find(n.users,function(e){return e.isAdmin});return!r||r._id==e._id}function U(t,r){var i=o.getUserFeatures();return e(function(e,u){0==t.id?L(i,r).then(function(n){e({project:t,config:n})},u):n.findById(t.id,function(n,t){if(!n){var c=o.getLoggedInUser(),s=S(c,t),a=E(i);return L(s?a:t.licenseConfigs,r).then(function(n){e({project:t,config:n})},u)}u(n)})})}function E(e){var n={};return _.each(e,function(e,t){n[t]=e.config}),n}function y(e,n,t,r){var i=o.getAllFeatures(),u=i[t],c=r?u.message_other:u.message;c=c||"";var s=j(e);return c=R(s,c),{key:"LICENSE",message:c,name:u.name,feature_key:t,isLicense:!0,skipUpgrade:u.skipUpgrade}}function R(e,n){return _.each(e,function(e,t){n=n.replace("{"+t+"}",e)}),n}function j(e){return{firstName:e.firstName,lastName:e.lastName,email:e.email,displayName:e.displayName}}function L(n,t){var r=e.defer(),i=n[t];if(console.log("previous one",i),i)r.resolve(i);else{var u=o.getAllFeatures(),c=u[t];console.log("********"),console.log(c);var s={key:"LICENSE",message:c.message,name:c.name,feature_key:t,isLicense:!0};console.log("last one...",s),r.reject(s)}return r.promise}function A(n){return e(function(e,t){u.getAll(function(r,o){if(r)t(r);else{var u=_.filter(o,function(e){return n&&e.project.id==n.id&&e.status==i.status.active});e(u)}})})}var C=this;C.checkUserRole=function(n,i,o,u){return e(function(t,r){"string"==typeof i&&(i=[i]);var u=e(function(e,n){e()});_.each(i,function(t){u=u.then(function(){return e(function(r,i){var u=_.filter(x,function(e){return e.key==t});console.log("this is a validators"),console.log("validator",u);var c=e(function(e,n){e()});_.each(u,function(e){c=c.then(function(){return e.validate(n,t,o)})}),c.then(r,i)})})}),u.then(t,r)}).then(null,function(n){return e(function(e,i){n&&n.key&&"LICENSE"==n.key&&u&&t.roleWarning(null,n).then(function(){window.cordova?a.open(encodeURI(r.upgradeUrl),"_system","location=no"):a.open(r.upgradeUrl,"_blank"),console.log("UPGRADE code goes here")},function(){console.log("UPGRADE CANCEL code goes here")}),i(n)})})};var x=[{key:"active_projects",validate:function(t,r,u){var c,s=e.defer(),a=o.getUserFeatures(),f=e(function(e,n){e()});return f=f.then(function(){return L(a,r)}).then(function(r){return c=r,e(function(e,o){n.getUserCreatedActiveProjects(t._id,function(n,u){n?o(n):"*"!==r.config.max&&u.length+1>r.config.max?o(y(t,r,i.USER_ROLES.ACTIVE_PROJECTS)):e()})})}).then(s.resolve,s.reject),s.promise}},{key:"active_tasks",validate:function(n,t,r){return e(function(t,o){var u=r.task,c=r.project||(u?u.project:null),a=e(function(e,n){u?g(u).then(e,n):e()});a.then(function(){return e(function(t,r){U(c,i.USER_ROLES.ACTIVE_TASKS).then(function(t){return e(function(e,r){var o=t.project,u=t.config;return"*"!==u.max?A(o).then(function(t){if(t.length+1>u.max){var c=S(n,o),a=s.getUserByRole(o.users,i.projectUserRole.admin);r(y(a,u,i.USER_ROLES.ACTIVE_TASKS,!c))}else e()},r):void e()})}).then(t,r)})}).then(t,function(e,r){e&&e.shouldSkip?t(r):m(e,n,c).then(o)})})}},{key:"assignee_project",validate:function(n,t,r){return e(function(t,o){var c=r.task,a=c.project;k(n,c).then(function(){return d(n,c).then(function(){U(a,i.USER_ROLES.ASSIGNEE_PROJECT).then(function(t){return e(function(e,r){var o=t.project,a=t.config;return"*"!==a.max?A(o).then(function(t){var f=_.filter(t,function(e){if(e.id==c.id)return!1;var t=u.getTaskUserByRole(e,i.taskUserRole.assignee);return e.status==i.status.active&&t&&t._id!=n._id});if(f.length+1>a.max){var l=S(n,o),d=s.getUserByRole(o.users,i.projectUserRole.admin);r(y(d,a,i.USER_ROLES.ASSIGNEE_PROJECT,!l))}else e()},r):void e()})}).then(function(e){t(e)},function(e){m(e,n,a).then(o)})})},null).then(null,function(e){e&&e.shouldSkip?t():o(e)})})}},{key:"max_users_project",validate:function(n,t,r){return e(function(t,o){var u="object"==typeof r.project?r.project:{id:r.project},c=r.invitedUser;c?c.invitedBy:n;U(u,i.USER_ROLES.MAX_USERS_PROJECT).then(function(t){return e(function(e,r){var o=t.project,u=t.config;if("*"!==u.max){var c=o.users.length;if(c+1>u.max){var a=S(n,o),f=s.getUserByRole(o.users,i.projectUserRole.admin);r(y(f,u,i.USER_ROLES.MAX_USERS_PROJECT,!a))}else e()}else e()})}).then(function(e){t(e)},function(e){m(e,n,u).then(o)})})}},{key:"labels",validate:function(n,t,r){var u,s=e.defer(),a=o.getUserFeatures(),f=r.label,l=e(function(e,n){e()});return l=l.then(function(){return L(a,t)}).then(function(t){return u=t,e(function(e,r){"*"!==t.config.max?c.getAll(function(o,u){if(o)r(o);else{var c=f?_.find(u,function(e){return e.id==f.id}):null;c?r(y(n,t.config,i.USER_ROLES.LABELS,!1)):u.length+1>t.config.max?r(y(n,t.config,i.USER_ROLES.LABELS,!1)):e()}}):e()})}).then(s.resolve,s.reject),s.promise}},{key:"labels_assign",validate:function(n,t,r){var i=e.defer(),u=r.labels||[],c=r.task,s=o.getUserFeatures(),a=_.filter(u,function(e){return e.checked}),f=_.map(a,function(e){return e.label}),l=e(function(e,n){e()});return l=l.then(function(){return p(f,c.id)}),l=l.then(function(n){return n?L(s,t):e(function(e,n){n({shouldSkip:!0})})}).then(i.resolve,function(e){e&&e.shouldSkip?i.resolve():i.reject(e)}),i.promise}},{key:"email_notifications",validate:function(n,t,r){var i=e.defer(),u=o.getUserFeatures(),c=e(function(e,n){e()});return c=c.then(function(e){return L(u,t)}).then(i.resolve,function(e){e&&e.shouldSkip?i.resolve():i.reject(e)}),i.promise}},{key:"custom_filters",validate:function(e,n,t){return v(e,n,t)}},{key:"search",validate:function(e,n,t){return v(e,n,t)}},{key:"file_upload",validate:function(e,n,t){return v(e,n,t)}},{key:"file_upload_size",validate:function(n,t,r){var i=e.defer(),u=r.file,c=o.getUserFeatures();console.log("file upload user features",s);var s,a=e(function(e,n){e()});return a=a.then(function(){return L(c,t)}).then(function(r){return s=r,console.log("top top",r),e(function(e,i){if("*"!==r.config.max){var o=u.size/1024/1024;console.log("file length...........sfsdfsdfsdf"),console.log(o),o>r.config.max?i(y(n,r.config,t,!1)):e()}else e()})}).then(i.resolve,i.reject),i.promise}},{key:"file_storage_max",validate:function(n,t,r){var i,u=e.defer(),c=r.file,s=o.getUserFeatures(),a=e(function(e,n){e()});return a=a.then(function(){return e(function(e,r){i=s[t],i?l.getLoggedInUserTotalStorage().then(function(o){if("*"!==i.config.max){var u=o+c.size,s=u/1024/1024;s>i.config.max?r(y(n,i.config,t,!1)):e()}else e()},r):e()})}).then(u.resolve,u.reject),u.promise}},{key:"my_feeds",validate:function(e,n,t){return v(e,n,t)}},{key:"task_history",validate:function(e,n,t){return v(e,n,t)}}];C.validate=function(n,t,r,i,o){var u=_.filter(x,function(e){return e.key==t}),c=e(function(e,n){e()});_.each(u,function(t){c=c.then(function(){var o=e.defer();return t.validate(n,r,i).then(function(){o.resolve()},function(e){e.isValidation?o.reject({result:!1,type:"validation",validationResult:e}):o.reject(e)}),o.promise})}),c.then(function(){o()},function(e){o(e)})},C.applyFeatureOnProjects=function(e,n,t){var r=["active_tasks","assignee_project","users_project"],i=o.getUserFeatures();_.each(n,function(e){e.licenseConfigs={},_.each(r,function(n){var t=i[n];t&&(e.licenseConfigs[n]=t.config)})}),t()}}])}();