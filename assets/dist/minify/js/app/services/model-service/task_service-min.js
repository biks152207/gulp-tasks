(function(){app.service("taskService",["$q","$rootScope","$http","API","RESPONSE_CODE","connectivity","taskModel","sortService","labelService","userModel","filterService","guidGenerator","dbEnums","date","sync","dueService","message","toastService","$timeout","$ionicListDelegate","$state","sharedData","reminderModel","settingsService","helperService","roleValidators",function(e,r,t,n,s,a,u,i,o,c,d,l,f,g,v,m,p,k,h,T,I,y,E,A,S,U){function R(e){r.recentTaskId=e}function D(e,r,t,n){var s={_id:e._id,displayName:e.displayName,displayShortName:e.displayShortName,email:e.email,avatar:e.avatar,getNotification:r,role:t,favourite:!1};return n&&(s.isAdmin=!0),s}function C(e,r){if(e.recurrence.due_date||r.recurrence.due_date){if(e.recurrence.due_date){if(r.recurrence.due_date){var t=moment(e.recurrence.due_date),n=moment(r.recurrence.due_date);return t<n?-1:t>n?1:0}return-1}return 1}return 0}function b(e,r){return e.priority==r.priority?0:e.priority<r.priority?1:-1}function O(e,r,t,n,s){var a=c.getTaskCustomOrders(),u=L(e,r,t,a,n,s);return u}function L(e,r,t,n,s,a){var u=_.find(n||[],function(r){return e.id==r.taskId}),i=_.find(n||[],function(e){return r.id==e.taskId});return u||i?u?i?u.order-i.order:-1:1:0}var w,j,B=this,N=angular.copy(y.BASIC_TASK),M=[];B.addAutoReminder=function(e){var r=A.getSettings(),t=null;return r.reminder.autoReminder.enable&&e&&(t={id:l.getId(),assignee:c.getLoggedInUser(),date_created:new Date,updatedBy:c.getLoggedInUser(),notificationChannels:r.reminder.autoReminder.channels,time:{id:0,title:r.reminder.autoReminder.time.title,value:r.reminder.autoReminder.time.value},auto:!0}),t},B.priorities={0:{name:"Priority 1",color:"#1775d2",number:0},1:{name:"Priority 2",color:" #6C6C6C",number:1},2:{name:"Priority 3",color:"#BABABA",number:2},3:{name:"Priority 4",number:3}},B.CHANNELS={EMAIL:"email",MOBILE:"mobile",WEB:"web"},B.TASK_TYPE_NAME={inbox:"Inbox",today:"Today",next7days:"Next 7 Days",overdue:"Overdue",watching:"Watching",favourites:"Favourites",closed:"Closed"},B.add=function(r){var t=e.defer();r.id=l.getId(),r.status=f.status.active,r.date_created=new Date,r.date_modified=new Date,r.updatedBy=c.getLoggedInUser();var n=[];if(r.assignee._id){var s=c.getLoggedInId()===r.assignee._id;n.push(D(r.assignee,!0,f.taskUserRole.assignee,s))}if(r.watchers.forEach(function(e){if(e.watcher._id){var r=c.getLoggedInId()===e.watcher._id,t=r||e.checked,s=r?f.taskUserRole.admin:f.taskUserRole.watcher;n.push(D(e.watcher,t,s,r))}}),!n.length){var a=c.getLoggedInUser();n.push(D(a,!0,f.taskUserRole.admin,!0))}r.users=angular.copy(n);var i=c.getLoggedInUser();return U.checkUserRole(i,[f.USER_ROLES.ACTIVE_TASKS,f.USER_ROLES.ASSIGNEE_PROJECT],{task:r,user:i,project:r.project},!0).then(function(){console.log("license check successful"),delete r.assignee,delete r.watchers,r.labels&&o.addTaskToLabels(r.labels,r.id);var e=r.labels;delete r.labels,v.add(f.collections.Task,{task:r,labels:e},f.events.Task.add),u.addOrUpdate(r,function(e,n){R(r.id),t.resolve(n)})},function(e){console.log("license check error"),console.log(e),t.reject(e)}),t.promise},B.copyTask=function(r){return e(function(t,n){var s=c.getLoggedInUser(),a=angular.copy(r);a.notes=[],delete a._id,delete a.id,a.id=l.getId(),a.status=f.status.active,a.date_created=new Date,a.date_modified=new Date,a.updatedBy=s,a.name=f.keys.COPY_TASK_PREFIX+a.name;var u=[],i=r.users||[];_.each(i,function(e){var r=e._id==s._id,t=e.role,n=D(e,e.getNotification,t,r);n.favourite=!!r&&n.favourite,u.push(n)}),a.users=u;var d=[],g=e(function(e,t){o.getAll().then(function(t){t?(t.forEach(function(e){var t=o.isTaskExists(r.id,e);t&&d.push({checked:!0,label:e})}),e()):e()},t)});g.then(function(){a.reminders=a.reminders||[],t(a)},n)})},B.bulkDueDateUpdate=function(r,t,n){var s=e.defer();return u.getSelected(r.taskIds,function(e,a){a&&B.updateDueDate(a,r.recurrence,t,n).then(s.resolve,s.reject)}),s.promise},B.updateDueDate=function(r,t,n,s){var a=e.defer();return _.each(r,function(e){var r=e.recurrence&&e.recurrence.due_date?new Date(e.recurrence.due_date):null;e.recurrence=angular.copy(t),e.recurrence&&e.recurrence.due_date&&(e.recurrence.due_date=new Date(e.recurrence.due_date)),n&&r&&e.recurrence.due_date&&(e.recurrence.due_date.setHours(r.getHours()),e.recurrence.due_date.setMinutes(r.getMinutes()),e.recurrence.due_date.setSeconds(r.getSeconds()),e.recurrence.due_date.setMilliseconds(r.getMilliseconds())),s&&r&&e.recurrence.due_date&&(e.recurrence.due_date.setFullYear(r.getFullYear()),e.recurrence.due_date.setMonth(r.getMonth()),e.recurrence.due_date.setDate(r.getDate())),e.updatedBy=c.getLoggedInUser()}),u.bulkUpdate(r,function(){a.resolve(!0)}),v.add(f.collections.Task,{taskList:r},f.events.Task.bulkDueDateUpdate),a.promise},B.bulkFavourites=function(t){var n=e.defer();return u.getSelected(t.taskIds,function(e,s){s&&(s.forEach(function(e){for(var r=0;r<e.users.length;r++)if(e.users[r]._id===c.getLoggedInId()){e.users[r].favourite=t.isFavourite;break}}),v.add(f.collections.Task,{isFavourite:t.isFavourite,taskIds:t.taskIds,userId:c.getLoggedInId()},f.events.Task.bulkFavourites),u.bulkUpdate(s,function(){r.$emit("task:update-favourite",t.isFavourite),n.resolve(t.isFavourite)}))}),n.promise},B.reminderDeleted=function(r,t){var n,s=e.defer();return u.findById(r,function(e,r){for(var a=0;a<r.reminders.length;a++)if(r.reminders[a].id==t){n=angular.copy(r.reminders[a]),r.reminders.splice(a,1);break}n?(v.add(f.collections.Task,{task:r,reminder:n},f.events.Task.deleteReminder),u.addOrUpdate(r,function(e,r){s.resolve(r)})):s.resolve()}),s.promise},B.reminderExecuted=function(r,t){var n,s=e.defer();return u.findById(r,function(e,r){for(var a=0;a<r.reminders.length;a++)if(r.reminders[a].id==t){n=r.reminders[a],n.notificationChannels.push.notified=!0;break}v.add(f.collections.Task,{task:r,reminder:n},f.events.Task.deleteReminder),u.addOrUpdate(r,function(e,r){s.resolve(r)})}),s.promise},B.removeTasksByProjectId=function(e){u.getAll(function(r,t){t.forEach(function(r){r.project.id==e.id&&u.delete(r.id,function(e,t){o.removeTaskFromAllLabels(r)})})})},B.update=function(r,t){var n=e.defer();if(angular.equals(r,t))n.resolve(void 0);else{r.updatedBy=c.getLoggedInUser();var s=[];if(r.assignee){var a=c.getLoggedInId()===r.assignee._id;s.push(D(r.assignee,!0,f.taskUserRole.assignee,a))}if(r.watchers.forEach(function(e){if(e.watcher._id){var r=c.getLoggedInId()===e.watcher._id,t=e.checked,n=r?f.taskUserRole.admin:f.taskUserRole.watcher;s.push(D(e.watcher,t,n,r))}}),!s.length){var i=c.getLoggedInUser();s.push(D(i,!0,f.taskUserRole.admin,!0))}r.users=angular.copy(s);var d=c.getLoggedInUser();U.checkUserRole(d,[f.USER_ROLES.ACTIVE_TASKS,f.USER_ROLES.ASSIGNEE_PROJECT],{task:r,user:d,project:r.project},!0).then(function(){delete r.assignee,delete r.watchers,r.labels&&o.addTaskToLabels(r.labels,r.id);var e=r.labels;delete r.labels,_.isEqual(r.prevRecurrence,r.recurrence)||(r.recurrence=m.setDueDate(r.recurrence)),delete r.prevRecurrence,r.removeReminders.forEach(function(e){E.delete(e,function(){})}),r.date_modified=new Date,v.add(f.collections.Task,{task:r,labels:e},f.events.Task.update),u.addOrUpdate(r,function(e,t){R(r.id),n.resolve(t)})},n.reject)}return n.promise},B.updateItem=function(e){e.status===f.status.deleted?u.delete(e.id,function(e,r){}):u.addOrUpdate(e,function(e,r){})},B.findActiveTaskById=function(r){var t=e.defer();return u.findActiveTaskById(r,function(e,r){t.resolve(r)}),t.promise},B.findById=function(r){var t=e.defer();return u.findById(r,function(e,r){t.resolve(r)}),t.promise},B.getAll=function(){var r=e.defer();return u.getAll(function(e,t){r.resolve(t)}),r.promise},B.getTasksByIds=function(r){var t=e.defer();return u.getAllByPredicate(function(e){var t=_.find(r,function(r){return r==e.id});return t},function(e,r){t.resolve(r)}),t.promise},B.taskCount=function(){var r=e.defer();return u.getAll(function(e,t){r.resolve(t.length)}),r.promise},B.setTaskObject=function(e){N=e},B.getTaskObject=function(){return w&&(N.project=w),N},B.clearTaskObject=function(){N=angular.copy(y.BASIC_TASK),w=void 0},B.taskObjectHasValue=function(){return N.name||N.notes.length},B.getTasksByType=function(t,n){var s=[],a=e.defer();return B.getAll().then(function(e){e.forEach(function(e){var r=angular.copy(e);console.log("task...",r),B.taskType[t](e,n)&&(e.due=g.getDateOnly(e.recurrence.due_date)||new Date("01/01/2050"),e.recurrence.due_time=g.getTime(e.recurrence.due_date),e.due_time=g.getTime(e.recurrence.due_date),e.isOverdued=g.isPastDay(e.recurrence.due_date),e.assignee=B.getAssignee(e),console.log("conversion..",e),s.push(e))});var u=i.getSortType();u=u||i.DEFAULT_SORT;var o=i.getOrder().value;r.showDateBar=!!u&&u.showDateBar,c.get(function(e){s=B.sortTasks(s,u,o,e),a.resolve(s)})}),a.promise},B.isUserAnAdmin=function(e,r){for(var t=0;t<e.users.length;t++)if(e.users[t]._id===r&&e.users[t].isAdmin)return!0;return!1},B.isUserAnAssignee=function(e,r){if(!e.project.id&&B.isUserAnAdmin(e,r))return!0;for(var t=0;t<e.users.length;t++)if(e.users[t].role===f.taskUserRole.assignee&&e.users[t]._id===r)return!0;return!1},B.getTaskUserByRole=function(e,r){var t=_.find(e.users,function(e){return e.role===r});return t},B.isUserAWatcher=function(e,r){for(var t=0;t<e.users.length;t++)if(e.users[t].getNotification&&e.users[t]._id===r)return!0;return!1},B.isFavourite=function(e,r){for(var t=0;t<e.users.length;t++)if(e.users[t]._id===r)return e.users[t].favourite;return!1},B.getAssignee=function(e){for(var r=0;r<e.users.length;r++)if(e.users[r].role===f.taskUserRole.assignee)return e.users[r];return null},B.taskType={inbox:function(e){return!e.project.id&&e.status==f.status.active},today:function(e){return g.isToday(e.recurrence.due_date)&&B.isUserAnAssignee(e,c.getLoggedInId())&&e.status==f.status.active},next7days:function(e){return g.isInNextNDays(e.recurrence.due_date,8)&&B.isUserAnAssignee(e,c.getLoggedInId())&&e.status==f.status.active},overdue:function(e){return g.isPastDay(e.recurrence.due_date)&&B.isUserAnAssignee(e,c.getLoggedInId())&&e.status==f.status.active},watching:function(e){return B.isUserAWatcher(e,c.getLoggedInId())&&e.status==f.status.active},favourites:function(e){return B.isFavourite(e,c.getLoggedInId())&&e.status==f.status.active},assignee:function(e,r){return r&&B.isUserAnAssignee(e,r._id)&&e.status==f.status.active},label:function(e,r){return r&&o.isTaskExists(e.id,r)&&e.status==f.status.active},filter:function(e,r){return r&&d.isTaskExists(e,r)&&e.status==f.status.active},project:function(e,r){return r&&e.project.id==r.id&&e.status==f.status.active},closed:function(e){return e.status==f.status.closed},"":function(e){return e.status==f.status.active}},B.addProjectToTaskObject=function(e){e&&(w={id:e.id,name:e.name,color:e.color})},B.getActiveReminders=function(e){var r=[];return e.reminders&&e.reminders.forEach(function(t){var n=B.isReminderActive(e,t);n&&r.push(t)}),r},B.countActiveReminders=function(e){var r=B.getActiveReminders(e);return r.length},B.isReminderActive=function(e,r){var t=(S.getScheduledTime(r,e.recurrence.due_date),!1),n=!0,s=!0;return r.notificationChannels.email&&r.notificationChannels.email.value&&!r.notificationChannels.email.notified&&(n=!1),r.notificationChannels.push&&r.notificationChannels.push.value&&!r.notificationChannels.push.notified&&(s=!1),s&&n||(t=!0),t},B.getCompletedTasks=function(r){var u=angular.extend({limit:25,skip:0},r),i=e.defer();a.isConnected()?t.get(n.task.GET.getCompleted,{params:u}).success(function(e){e.response_code===s.SUCCESS?(e.data.completedTasks.forEach(function(e){e.due=g.getDateOnly(e.recurrence.due_date)||new Date("01-01-2050"),e.recurrence.due_time=g.getTime(e.recurrence.due_date),e.due_time=g.getTime(e.recurrence.due_date),e.isOverdued=g.isPastDay(e.recurrence.due_date),e.assignee=B.getAssignee(e)}),i.resolve(e.data.completedTasks)):e.response_code===s.ERROR&&i.reject({error:!0,msg:p.errorMessages[e.errors.value],results:e})}).error(function(e){i.reject({error:!0,msg:p.errorMessages.GENERAL,results:e})}):i.reject({error:!0,msg:p.errorMessages.CONNECTION_REQUIRED});var o=i.promise;return o},B.unCompleteTasks=function(u){var i=e.defer(),o=_.isArray(u)?u:[u],d=o,l=c.getLoggedInUser(),g=e(function(e,r){e()});return _.each(o,function(e){g=g.then(function(){return U.checkUserRole(l,f.USER_ROLES.ACTIVE_TASKS,{project:e.project,user:l},!0)})}),g.then(function(){return e(function(e,i){a.isConnected()?t.post(n.task.unCompleteTasks,d).success(function(t){t.response_code===s.SUCCESS?B.addTaskFromServer(t.data.tasks).then(function(){e(t.data.tasks?t.data.tasks:u),r.$emit("task-reopen",t.data.tasks)},i):i({error:!0,msg:p.errorMessages[t.errors.value],results:t})}).error(function(e){i({error:!0,msg:p.errorMessages.GENERAL,results:e})}):i({error:!0,msg:p.errorMessages.CONNECTION_REQUIRED})})}).then(i.resolve,i.reject),i.promise},B.addTaskFromServer=function(r){var t=e.defer();return u.bulkUpdate(r,function(e,n){e&&t.reject(e),t.resolve(r)},t.reject),t.promise},B.getTaskFromServer=function(r){var s=e.defer();return a.isConnected()?t.get(n.task.GET.view+r).then(function(e){s.resolve(e.data.data.task)},function(e){s.reject({error:!0,msg:p.errorMessages.GENERAL})}):s.reject({error:!0,msg:p.errorMessage.CONNECTION_REQUIRED}),s.promise},B.moveTask=function(r,t,n,s,a,u,i,o){var c,d,l=e.defer(),f=r[t],g=!1,v=r;t<n?(c=r[n],n+1<r.length&&(d=r[n+1])):t>n?(d=r[n],n-1>=0&&(c=r[n-1])):t<s?(c=r[n-1],n+1<r.length&&(d=r[n+1])):t>s&&(d=r[n-1],n-1>=0&&(c=r[n-1]));var m;if(u){var p=r[s],k=B.areDateGroupEqual(f,p);if(!k){var _=f.recurrence;m=_&&_.due_date?new Date(_.due_date):null,f.recurrence=angular.copy(p.recurrence),f.recurrence&&f.recurrence.due_date&&(f.recurrence.due_date=new Date(f.recurrence.due_date),f.recurrence.due_date.setHours(0),f.recurrence.due_date.setMinutes(0),f.recurrence.due_date.setSeconds(0),f.recurrence.due_date.setMilliseconds(0)),g=!0}}var h=1,T=-1;if(c){var I=i&&"plan"==i.value?1:B.compareTasks(f,c,a,g,i,o);h=I}if(d){var I=i&&"plan"==i.value?-1:B.compareTasks(f,d,a,g,i,o);T=I}var y=h>=0&&T<=0;return y||"priority"!=i.value||(t<n?y=h>=0:t>n&&(y=T<=0)),y?(console.log("step 2"),e(function(e,r){g?(m&&f.recurrence&&f.recurrence.due_date&&(f.recurrence.due_date.setHours(m.getHours()),f.recurrence.due_date.setMinutes(m.getMinutes()),f.recurrence.due_date.setSeconds(m.getSeconds()),f.recurrence.due_date.setMilliseconds(m.getMilliseconds())),console.log("step 3"),B.updateDueDate([f],f.recurrence).then(function(){e()},r)):e()}).then(function(){var e=!1;g||(v.splice(t,1),v.splice(n,0,f),e=!0,l.resolve({tasks:v})),console.log("step 4"),B.saveTaskCustomOrder(f,c,d,a,i,o).then(function(){console.log("step 5"),e||l.resolve({tasks:v,requireSort:!0})},function(){e||l.reject()})})):l.resolve({tasks:null}),l.promise},B.saveTaskCustomOrder=function(r,t,n,s,a,u){var i=e.defer();return B.getAll().then(function(e){e.forEach(function(e){e.due=g.getDateOnly(e.recurrence.due_date)||new Date("01-01-2050"),e.recurrence.due_time=g.getTime(e.recurrence.due_date),e.due_time=g.getTime(e.recurrence.due_date)});var o=B.sortTasks(e,a,u,s),d=_.findIndex(o,function(e){return e.id==r.id}),l=t?_.findIndex(o,function(e){return e.id==t.id}):-1,m=n?_.findIndex(o,function(e){return e.id==n.id}):-1,p=o.splice(d,1)[0];l>=0?d>l?o.splice(l+1,0,p):o.splice(l,0,p):m>=0&&(d>m?o.splice(m,0,p):o.splice(m-1,0,p));var k=[],h=1;_.each(o,function(e){k.push({taskId:e.id,order:h++})}),console.log("sorted task"),console.log(_.map(o,function(e){return e.name}).join(" , ")),c.setTaskCustomOrders(k),v.add(f.collections.User,{user:s,taskCustomOrder:k},f.events.Task.moveTaskOrder),i.resolve()}),i.promise},B.sortTasks=function(e,r,t,n){var s;if("plan"==r.value)s=e.sort(function(e,s){var a=O(e,s,n,r,t);return a});else{s=e.sort(function(e,s){var a=O(e,s,n,r,t);return a});var a="asc"==t?"desc":"asc",u="priority"==r.value?a:t;s="priority"==r.value?_.orderBy(s,["priority","due","due_time"],[a,t,t]):_.orderBy(s,[r.value,"due","due_time","priority"],[u,u,u,"asc"])}return s},B.customOrderCompareTasks=function(e,r,t,n,s){if(!e&&!r)return 0;if(!e)return-1;if(!r)return 1;var a;a=C(e,r);var u="date compare result "+a;if(0==a){var i=b(e,r);if(u=u+";;;priority compare result "+i,0==i){var o=O(e,r,t);return u=u+";;;custom order compare result "+o,o}return i*("asc"==s?1:-1)}return a*("asc"==s?1:-1)},B.compareTasks=function(e,r,t,n,s,a){if(null==e&&null==r)return 0;if(null==e)return-1;if(null==r)return 1;var u=a;"due"==s.value&&(u="desc");var i;i=C(e,r);var o=b(e,r);return"priority"!=s.value||n?0!=i||n?i*("asc"==a?1:-1):o*("asc"==u?1:-1):0==o?i*("asc"==a?1:-1):o*("asc"==u?1:-1)},B.areDateGroupEqual=function(e,r){var t=e.recurrence.due_date,n=r.recurrence.due_date,s=C(e,r);if(s){var a=g.getDateGroupHeader(t),u=g.getDateGroupHeader(n);return a==u}return!0},B.bulkCompleteRequest=function(t,n,s){var a=e.defer();if(r.rightDefaultViewVisible&&r.$emit("task:bulkCompleted"),t){M=M||[];M.length>0;M=M.concat(t),n?a.resolve():(k.openTaskCompleteToast(),j=s,_.each(t,function(e){u.delete(e.id,!0)}),r.$emit("taskList-update"),a.resolve())}else a.resolve();return a.promise},B.removeFromBulkCompleteList=function(e){M=M||[],_.remove(M,function(r){return r.id==e.id}),u.addOrUpdate(e,function(){})},r.$on("bulk-complete:response",function(e,t){if(t)_.each(M,function(e){e.status=f.status.active,u.addOrUpdate(e,!0,function(){})}),r.$emit("taskList-update"),console.log("undo bulk complete "),console.log(_.map(M,function(e){return e.name})),j&&I.go(j.name,j.params),T.closeOptionButtons();else{var n=[];M.length&&(M.forEach(function(e){n.push(e.id)}),B.bulkComplete(M).then(function(){}),console.log("---completing tasks--"),console.log(_.map(M,function(e){return e.name})))}M=[]}),B.bulkComplete=function(r){var t=e.defer();if(r){var n=new Date;r.forEach(function(e){e.recurrence=m.setDueDate(e.recurrence,n),e.status=e.recurrence.isRecurring?f.status.active:f.status.complete,e.date_modified=n,e.updatedBy=c.getLoggedInUser()}),v.add(f.collections.Task,{taskList:r,userId:c.getLoggedInId()},f.events.Task.bulkComplete),u.bulkUpdate(r,function(){t.resolve(!0)})}return t.promise},B.setTaskProps=function(e){return e.due=g.getDateOnly(e.recurrence.due_date)||new Date("01-01-2050"),e.recurrence.due_time=g.getTime(e.recurrence.due_date),e.isOverdued=g.isPastDay(e.recurrence.due_date),e.assignee=B.getAssignee(e),e},B.delete=function(e,r){var t=_.map(e,function(e){return e.id}),n=c.getLoggedInUser();v.add(f.collections.Task,{taskIds:t,updatedBy:n},f.events.Task.delete),_.each(t,function(e){u.delete(e,function(){r()})})},B.sendProjectAdminInvitation=function(e){}}])}).call(this);