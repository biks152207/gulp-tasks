(function(){app.service("user",["$http","$q","$window","$state","$rootScope","$ionicLoading","API","connectivity","socket","message","RESPONSE_CODE","sharedData","notificationModel","projectModel","sync","TodoZuDB","labelModel","filterModel","taskModel","settingsModel","userModel","sortService","taskListView",function(e,s,r,o,t,n,i,a,c,l,u,g,d,f,p,v,R,O,m,E,C,I,_){function N(e){var o=s.defer();return r.localStorage.setItem("timestamp",new Date),v.createInstances().then(function(){C.addOrUpdate(e.userInfo,function(){}),e.taskCustomOrders&&C.setTaskCustomOrders(e.taskCustomOrders),C.setToken(e.token,function(){}),E.addOrUpdate(e.settings,function(){}),e.settings.filterView&&E.setAllFilterViews(e.settings.filterView),e.settings.sortOption&&E.setAllSortOptions(e.settings.sortOption),e.features&&C.saveUserFeatures(e.features),e.licenseFeatures&&C.saveAllFeatures(e.licenseFeatures),f.bulkUpdate(e.projects,function(){}),R.bulkUpdate(e.labels,function(){}),O.bulkUpdate(e.filters,function(){}),m.bulkUpdate(e.tasks,function(){}),d.bulkUpdate(e.notifications,function(){}),e.api_version&&r.localStorage.setItem("x-api-version",e.api_version),o.resolve(!0)}),o.promise}var S=this;S.register=function(r){var t=s.defer();return a.isConnected()?(n.show(),e.post(i.user.register,r).success(function(e){n.hide(),e.response_code===u.SUCCESS?(C.setRequestLoginEmail(r.email),l.setAlert(l.successMessages.CONFIRM_EMAIL_ADDRESS),o.go("/login")):e.response_code===u.ERROR&&(console.log(e),t.resolve({error:!0,message:l.errorMessages[e.errors.value]}))}).error(function(e){n.hide(),t.resolve({error:!0,message:l.errorMessages.CONNECTION_ERROR})})):t.resolve({error:!0,message:l.errorMessages.CONNECTION_ERROR}),t.promise},S.forgotPassword=function(r){var t=s.defer();return a.isConnected()?e.post(i.user.forgotPassword,r).success(function(e){e.response_code===u.SUCCESS?(l.setAlert(l.successMessages.FORGOT_PASSWORD_EMAIL_SENT),C.setRequestLoginEmail(e.data.email),o.go("/login")):e.response_code===u.ERROR&&(console.log(e),t.resolve({error:!0,message:l.errorMessages[e.errors[0].value]}))}).error(function(e){t.resolve({error:!0,message:l.errorMessages.CONNECTION_ERROR})}):t.resolve({error:!0,message:l.errorMessages.CONNECTION_ERROR}),t.promise},S.resetPassword=function(r){var t=s.defer();return a.isConnected()?e.post(i.user.resetPassword,r).success(function(e){console.log(e),e.response_code===u.SUCCESS?(S.clearAll(),l.setAlert(l.successMessages.RESET_PASSWORD_CONFIRMATION),C.setRequestLoginEmail(e.data.email),o.go("/login")):e.response_code===u.ERROR&&t.resolve({error:!0,message:l.errorMessages[e.errors.value]})}).error(function(e){t.resolve({error:!0,message:l.errorMessages.CONNECTION_ERROR})}):t.resolve({error:!0,message:l.errorMessages.CONNECTION_ERROR}),t.promise},S.login=function(r){var o=s.defer();return a.isConnected()?e.post(i.user.login,r).success(function(e){console.log("user login...."),console.log(e),e.response_code===u.SUCCESS?N(e.data).then(function(e){I.setAll().then(function(){o.resolve({success:e})})}):e.response_code===u.ERROR&&o.resolve({error:!0,message:l.errorMessages[e.errors.value]})}).error(function(){o.resolve({error:!0,message:l.errorMessages.CONNECTION_ERROR})}):o.resolve({error:!0,message:l.errorMessages.CONNECTION_ERROR}),o.promise},S.logout=function(s,r){if(n.show(),C.getDeviceUniqueId()){var a={userId:C.getLoggedInId(),uid:C.getDeviceUniqueId(),device_token:C.getDeviceToken()};e.post(i.user.logout,a).success(function(e){200===e.response_code?(S.clearAll(),t.$emit("logoff-success"),s&&r?o.go("/login",{returnUrl:s,params:r}):o.go("/login"),n.hide()):500===e.response_code&&t.$emit("show-message","general","error")}).error(function(e){n.hide()})}else S.clearAll(),n.hide(),t.$emit("logoff-success"),s&&r?o.go("/login",{returnUrl:s,params:r}):o.go("/login")},S.clearAll=function(){_.clearFilterView(),c.disconnect(),C.clearSession(),v.dropDatabase()},S.validatePassword=function(r,o){var t=s.defer();return data={password:r,userId:C.getLoggedInId()},e.post(i.user.validatePassword,data).success(function(e){200===e.response_code?t.resolve(e.data.result):t.resolve(!1)}).error(function(e){t.reject(e)}),t.promise},S.registerDeviceInfo=function(){var r=s.defer(),o={userId:C.getLoggedInId()};return o.deviceInfo={uid:C.getDeviceUniqueId(),device_type:ionic.Platform.platform(),device_token:C.getDeviceToken()},e.post(i.user.registerDeviceInfo,o).then(function(e){r.resolve()},function(e){r.reject(e)}),r.promise},S.logoutListener=t.$on("logout",function(e,s,r){S.logout(s,r)})}])}).call(this);