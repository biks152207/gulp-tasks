(function(){app.service("noteService",["$http","$q","$rootScope","taskModel","Upload","sync","dbEnums","connectivity","RESPONSE_CODE","message","API","userModel",function(e,o,s,t,r,n,d,a,i,c,l,u){function f(e,o){for(var s=0;s<e.length;s++)if(e[s].id==o){e.splice(s,1);break}return e}var p=this;p.add=function(e){var s=o.defer();return t.findById(e.taskId,function(o,r){e.note.date_modified=new Date,r.notes.push(e.note),n.add(d.collections.Task,{task:r,note:e.note},d.events.Task.addNote),t.addOrUpdate(r,function(e,o){s.resolve(o)})}),s.promise},p.edit=function(e){var s=o.defer();return t.findById(e.taskId,function(o,r){for(var a=0;a<r.notes.length;a++)if(r.notes[a].id===e.note.id){r.notes[a].description=e.note.description,r.notes[a].date_modified=new Date;break}n.add(d.collections.Task,{task:r,note:e.note},d.events.Task.updateNote),t.addOrUpdate(r,function(e,o){s.resolve(o)})}),s.promise},p.delete=function(e){var s=o.defer();return t.findById(e.taskId,function(o,r){e.noteIds.forEach(function(e){r.notes=angular.copy(f(r.notes,e))}),r.date_modified=Date.now(),n.add(d.collections.Task,{task:r,noteIds:e.noteIds,updatedBy:u.getLoggedInUser()},d.events.Task.deleteNote),t.addOrUpdate(r,function(e,o){s.resolve(o)})}),s.promise},p.uploadNote=function(e){var t=o.defer();return a.isConnected()?r.upload({url:l.task.uploadNote,fields:e,file:e.file}).progress(function(e){var o=parseFloat(e.loaded),t=parseFloat(e.total);s.progressPercentage=100*(o/(2*t)),console.log(s.progressPercentage)}).success(function(e){console.log(e),e.response_code==i.SUCCESS?(s.progressPercentage=100,t.resolve({error:!1,msg:c.successMessages.ATTACHMENT_ADDED})):e.response_code===i.ERROR&&t.resolve({error:!0,msg:c.errorMessages[e.errors.value],results:e})}).error(function(e){t.resolve({error:!0,msg:c.errorMessages.GENERAL,results:e})}):t.resolve({error:!0,msg:c.errorMessages.CONNECTION_REQUIRED}),t.promise}}])}).call(this);