(function(){app.service("project",["$http","$rootScope","$q","$state","RESPONSE_CODE","connectivity","message","API","sharedData","dbEnums","guidGenerator","projectModel","sync","userModel","filterService","taskService","userRoleValidator","roleValidators",function(e,r,t,o,s,n,d,i,c,u,a,l,f,v,g,p,I,j){var m=this;m.addOrUpdate=function(e,r){var o=t.defer();v.getLoggedInUser();return f.add(u.collections.Project,{project:e,update:r},u.events.Project.addOrUpdate),l.addOrUpdate(e,function(e,r){o.resolve(r)}),o.promise},m.archive=function(e){e.users.forEach(function(e){e._id===v.getLoggedInId()&&(e.status=u.status.archived)});var r=t.defer();return f.add(u.collections.Project,{userId:v.getLoggedInId(),project:e},u.events.Project.archive),l.addOrUpdate(e,function(e,t){r.resolve(t)}),r.promise},m.delete=function(e){var r=t.defer();return e.updatedBy=v.getLoggedInUser(),f.add(u.collections.Project,e,u.events.Project.delete),l.delete(e.id,function(t,o){g.removeProjectFromAllFilters(e),p.removeTasksByProjectId(e),r.resolve()}),r.promise},m.deleteUser=function(e,r){e.users.forEach(function(e,t,o){e.email===r.email&&o.splice(t,1)});var o=t.defer();return f.add(u.collections.Project,{deletedUser:r,projectId:e.id},u.events.Project.deleteUser),l.addOrUpdate(e,function(e,r){o.resolve(r)}),o.promise},m.findById=function(e){var r=t.defer();return l.findById(e,function(e,t){r.resolve(t)}),r.promise},m.getAll=function(){var e=t.defer();return l.getAll(function(r,t){e.resolve(t)}),e.promise},m.getAllArchived=function(){var e=t.defer();return l.getAllArchived(function(r,t){e.resolve(t)}),e.promise},m.getAllProjectsUsers=function(){var e=[],r=[],o=t.defer();return l.getAll(function(t,s){s.forEach(function(t){for(var o=0;o<t.users.length;o++){var s=t.users[o];r[s._id]||(e.push(s),r[s._id]=!0)}}),o.resolve(e)}),o.promise},m.getUserFromAllProjects=function(e){var r=t.defer();return m.getAllProjectsUsers().then(function(t){for(var o=null,s=0;s<t.length;s++)if(t[s]._id==e){o=t[s];break}r.resolve(o)}),r.promise},m.getProjectUserById=function(e,r){for(var t=0;t<e.users.length;t++)if(e.users[t]._id===r)return e.users[t]},m.getProjectAdmin=function(e){for(var r=0;r<e.users.length;r++)if(e.users[r].isAdmin)return e.users[r]},m.getUserRole=function(e,r){for(var t=0;t<e.users.length;t++)if(e.users[t]._id===r)return e.users[t].role},m.left=function(e){var r=t.defer();return f.add(u.collections.Project,{userId:v.getLoggedInId(),project:e},u.events.Project.left),l.delete(e.id,function(t,o){g.removeProjectFromAllFilters(e),p.removeTasksByProjectId(e),r.resolve()}),r.promise},m.reorder=function(e,r){e.forEach(function(e,r){e.users.forEach(function(e){e._id==v.getLoggedInId()&&e.status===u.status.active&&(e.order=r)})}),f.add(u.collections.Project,{projects:e,userId:v.getLoggedInId()},u.events.Project.reorder),l.bulkUpdate(e,!0,r)},m.reSendInvitation=function(r){var o=t.defer();return n.isConnected()?e.post(i.project.reSendInvitation,r).success(function(e){e.response_code===s.SUCCESS?o.resolve({error:!1,message:d.successMessages.PROJECT_INVITATION_RESENT}):e.response_code===s.ERROR&&o.resolve({error:!0,message:d.errorMessages[e.errors.value]})}).error(function(){o.resolve({error:!0,message:d.errorMessages.CONNECTION_ERROR})}):o.resolve({error:!0,message:d.errorMessages.CONNECTION_ERROR}),o.promise},m.sendInvitation=function(e,r){var o=t.defer();return delete r.accessToken,delete r.accessTokenExpired,delete r.approvalToken,e.users.push(r),f.add(u.collections.Project,{projectId:e.id,invitedUser:r},u.events.Project.sendInvitation),l.addOrUpdate(e,function(e,r){o.resolve(r)}),o.promise},m.unArchive=function(e){e.users.forEach(function(e){e._id===v.getLoggedInId()&&(e.status=u.status.active)});var r=t.defer();return f.add(u.collections.Project,{userId:v.getLoggedInId(),project:e},u.events.Project.unArchive),l.addOrUpdate(e,function(e,t){r.resolve(t)}),r.promise},m.updateItem=function(e){e.status===u.status.deleted?l.delete(e.id,function(e,r){}):l.addOrUpdate(e,function(e,r){})},m.canDeleteProject=function(e){var r=v.getLoggedInUser();if(!e||!r)return!1;var t=_.find(e.users,function(e){if(e._id&&e._id==r._id)return!0});return!!t&&(t.role==u.projectUserRole.admin&&e.users.length<=1)},m.canDeleteUser=function(e,r){if(!r||!e||e.users.length<=0)return!1;var t=_.find(e.users,function(e){if(e._id&&e._id==r._id)return!0});return!!t&&t.role==u.projectUserRole.admin}}])}).call(this);